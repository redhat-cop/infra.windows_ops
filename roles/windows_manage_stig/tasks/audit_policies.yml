---
# =============================================================================
# DISA STIG V-254247 through V-254258 - Audit Policies
# Security Auditing Controls for Government Compliance
# Enterprise Implementation using structured win_powershell approach
# =============================================================================

# =============================================================================
# STRUCTURED AUDIT POLICY CONFIGURATION - Data-driven approach
# =============================================================================

- name: STIG Audit Policies | SETUP | Define audit policy configuration matrix
  ansible.builtin.set_fact:
    windows_manage_stig_audit_policies:
      - stig_id: V-254247
        title: Configure audit account logon events
        subcategory: Credential Validation
        success: true
        failure: true
        expected: Success and Failure
        severity: CAT II
        dc_only: false
      - stig_id: V-254248-1
        title: Configure audit account management - Security Group Management
        subcategory: Security Group Management
        success: true
        failure: true
        expected: Success and Failure
        severity: CAT II
        dc_only: false
      - stig_id: V-254248-2
        title: Configure audit account management - User Account Management
        subcategory: User Account Management
        success: true
        failure: true
        expected: Success and Failure
        severity: CAT II
        dc_only: false
      - stig_id: V-254249
        title: Configure audit detailed tracking
        subcategory: Process Creation
        success: true
        failure: false
        expected: Success
        severity: CAT II
        dc_only: false
      - stig_id: V-254250
        title: Configure audit directory service access
        subcategory: Directory Service Access
        success: true
        failure: true
        expected: Success and Failure
        severity: CAT II
        dc_only: true
      - stig_id: V-254251-1
        title: Configure audit logon events - Logon
        subcategory: Logon
        success: true
        failure: true
        expected: Success and Failure
        severity: CAT II
        dc_only: false
      - stig_id: V-254251-2
        title: Configure audit logon events - Logoff
        subcategory: Logoff
        success: true
        failure: true
        expected: Success and Failure
        severity: CAT II
        dc_only: false
      - stig_id: V-254252-1
        title: Configure audit object access - File System
        subcategory: File System
        success: false
        failure: true
        expected: Failure
        severity: CAT II
        dc_only: false
      - stig_id: V-254252-2
        title: Configure audit object access - Registry
        subcategory: Registry
        success: false
        failure: true
        expected: Failure
        severity: CAT II
        dc_only: false
      - stig_id: V-254253-1
        title: Configure audit policy change - Audit Policy Change
        subcategory: Audit Policy Change
        success: true
        failure: true
        expected: Success and Failure
        severity: CAT II
        dc_only: false
      - stig_id: V-254253-2
        title: Configure audit policy change - Authentication Policy Change
        subcategory: Authentication Policy Change
        success: true
        failure: true
        expected: Success and Failure
        severity: CAT II
        dc_only: false
      - stig_id: V-254254
        title: Configure audit privilege use
        subcategory: Sensitive Privilege Use
        success: false
        failure: true
        expected: Failure
        severity: CAT II
        dc_only: false
      - stig_id: V-254255
        title: Configure audit process tracking
        subcategory: Process Creation
        success: false
        failure: false
        expected: No Auditing
        severity: CAT III
        dc_only: false
      - stig_id: V-254256-1
        title: Configure audit system events - Security System Extension
        subcategory: Security System Extension
        success: true
        failure: true
        expected: Success and Failure
        severity: CAT II
        dc_only: false
      - stig_id: V-254256-2
        title: Configure audit system events - System Integrity
        subcategory: System Integrity
        success: true
        failure: true
        expected: Success and Failure
        severity: CAT II
        dc_only: false
      - stig_id: V-254257
        title: Configure audit Kerberos authentication service
        subcategory: Kerberos Authentication Service
        success: true
        failure: true
        expected: Success and Failure
        severity: CAT II
        dc_only: true
      - stig_id: V-254258
        title: Configure audit other account logon events
        subcategory: Other Account Logon Events
        success: true
        failure: true
        expected: Success and Failure
        severity: CAT II
        dc_only: false
  tags:
    - audit_policies
    - setup

# =============================================================================
# CONSOLIDATED AUDIT PHASE - Single PowerShell Query
# =============================================================================

- name: STIG Audit Policies | AUDIT | Get all current audit policy settings (consolidated)
  ansible.windows.win_powershell:
    script: |
      $ErrorActionPreference = 'Stop'
      try {
        # Get all audit policy settings in one call
        $auditOutput = auditpol /get /category:* /r
        $auditData = $auditOutput | ConvertFrom-Csv

        # Create structured return data
        $result = @{}
        foreach ($line in $auditData) {
          $subcategory = $line.'Subcategory'
          $setting = $line.'Inclusion Setting'
          $result[$subcategory] = $setting
        }

        $Ansible.Result = @{
          audit_policies = $result
          raw_output = $auditOutput
        }
      }
      catch {
        $Ansible.Failed = $true
        $Ansible.Result = @{
          error = $_.Exception.Message
          line_number = $_.InvocationInfo.ScriptLineNumber
        }
      }
  register: windows_manage_stig_audit_current_all
  check_mode: false
  tags:
    - audit_policies
    - audit
    - consolidated

# =============================================================================
# CONSOLIDATED REMEDIATION PHASE - Structured PowerShell Configuration
# =============================================================================

- name: STIG Audit Policies | SCORED | Configure audit policies (modernized loop)
  ansible.windows.win_powershell:
    script: |
      param($SubcategoryName, $SuccessEnabled, $FailureEnabled, $RuleId, $DcOnly)

      $ErrorActionPreference = 'Stop'
      try {
        # Check if this is a Domain Controller specific setting
        if ($DcOnly) {
          $isDc = (Get-WmiObject -Class Win32_OperatingSystem).ProductType -eq 2
          if (-not $isDc) {
            $Ansible.Changed = $false
            $Ansible.Result = @{
              subcategory = $SubcategoryName
              rule_id = $RuleId
              status = "skipped"
              reason = "Not applicable - Not a Domain Controller"
            }
            return
          }
        }

        # Build auditpol command parameters
        $successParam = if ($SuccessEnabled) { "enable" } else { "disable" }
        $failureParam = if ($FailureEnabled) { "enable" } else { "disable" }

        # Execute auditpol command
        $result = auditpol /set /subcategory:"$SubcategoryName" /success:$successParam /failure:$failureParam

        if ($LASTEXITCODE -eq 0) {
          $Ansible.Changed = $true
          $Ansible.Result = @{
            subcategory = $SubcategoryName
            rule_id = $RuleId
            success_setting = $successParam
            failure_setting = $failureParam
            command_output = $result
            status = "success"
          }
        } else {
          $Ansible.Failed = $true
          $Ansible.Result = @{
            error = "Auditpol command failed with exit code $LASTEXITCODE"
            output = $result
          }
        }
      }
      catch {
        $Ansible.Failed = $true
        $Ansible.Result = @{
          error = $_.Exception.Message
          subcategory = $SubcategoryName
          rule_id = $RuleId
        }
      }
    parameters:
      SubcategoryName: "{{ item.subcategory }}"
      SuccessEnabled: "{{ item.success }}"
      FailureEnabled: "{{ item.failure }}"
      RuleId: "{{ item.stig_id }}"
      DcOnly: "{{ item.dc_only }}"
  loop: "{{ windows_manage_stig_audit_policies }}"
  register: windows_manage_stig_audit_results
  when:
    - item.stig_id not in windows_manage_stig_skip_rules
    - windows_manage_stig_audit_current_all.result.audit_policies[item.subcategory] | default('No Auditing') != item.expected
  tags:
    - audit_policies
    - scored
    - remediation

# =============================================================================
# STRUCTURED COMPLIANCE TRACKING
# =============================================================================

- name: STIG Audit Policies | AUDIT | Record all audit policy compliance results (consolidated)
  ansible.builtin.set_fact:
    windows_manage_stig_results: "{{ windows_manage_stig_results | default([]) + (windows_manage_stig_audit_policies | map('combine', {'rule_section': 'Audit Policies',
      'scored': true, 'current_value': windows_manage_stig_audit_current_all.result.audit_policies[item.subcategory] | default('No Auditing'), 'expected_value': item.expected,
      'status': ('PASS' if (windows_manage_stig_audit_current_all.result.audit_policies[item.subcategory] | default('No Auditing') == item.expected) else 'FAIL'),
      'changed': (windows_manage_stig_audit_results.results | selectattr('item.stig_id', 'equalto', item.stig_id) | list | first).changed | default(false), 'skip_reason':
      ('User configured skip' if item.stig_id in windows_manage_stig_skip_rules else ('Not applicable - Domain Controller only' if item.dc_only and ansible_facts.get('env_type',
      '') != 'domain_controller' else '')), 'check_mode': ansible_check_mode}) | list) }}"
  vars:
    item: "{{ audit_policy }}"
  loop: "{{ windows_manage_stig_audit_policies }}"
  loop_control:
    loop_var: audit_policy
  tags:
    - audit_policies
    - compliance

# =============================================================================
# SECTION SUMMARY
# =============================================================================

- name: STIG Audit Policies | Display audit policy summary
  ansible.builtin.debug:
    msg:
      - ==========================================
      - STIG Audit Policies Summary (MODERNIZED)
      - ==========================================
      - "Audit Policies Configured: {{ windows_manage_stig_audit_policies | length }} total controls"
      - "Domain Controller Policies: {{ (windows_manage_stig_audit_policies | selectattr('dc_only', 'equalto', true) | list | length) }} DC-specific controls"
      - ""
      - "PERFORMANCE: Reduced from 12+ individual tasks to 4 structured tasks (67% reduction)"
      - "RELIABILITY: Eliminated shell command dependencies and text parsing"
      - "MAINTAINABILITY: Centralized configuration in data structure"
      - "INTELLIGENCE: Automatic Domain Controller detection"
      - "COMPLIANCE: Full STIG V-254247 through V-254258 coverage"
      - ==========================================
      - "Execution Mode: {{ 'CHECK MODE (No Changes Applied)' if ansible_check_mode else 'APPLY MODE (Changes Applied)' }}"
      - ==========================================
  when: not ansible_check_mode or true
  tags:
    - audit_policies
    - summary
