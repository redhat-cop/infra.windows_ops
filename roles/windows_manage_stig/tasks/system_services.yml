---
# =============================================================================
# DISA STIG V-254401 through V-254450 - System Services (CONSOLIDATED)
# Windows Service Security Controls for Reduced Attack Surface
# Enterprise Implementation using data-driven approach with proper idempotency
# =============================================================================

# =============================================================================
# STRUCTURED SYSTEM SERVICES CONFIGURATION - Data-driven approach
# =============================================================================

- name: STIG System Services | SETUP | Define system services configuration matrix
  ansible.builtin.set_fact:
    windows_manage_stig_system_services:
      # CRITICAL SECURITY SERVICES (CAT I - Must be disabled)
      critical_disable:
        - name: tlntsvr
          display_name: Telnet Service
          state: stopped
          start_mode: disabled
          stig_id: V-254405
          severity: CAT I
          description: Telnet transmits credentials in clear text
          justification: Security vulnerability - unencrypted transmission

      # HIGH-RISK SERVICES TO DISABLE (Attack surface reduction)
      standard_disable:
        - name: Fax
          display_name: Fax Service
          state: stopped
          start_mode: disabled
          stig_id: V-254401
          severity: CAT II
          description: Legacy fax service - unnecessary attack surface
        - name: FTPSVC
          display_name: FTP Publishing Service
          state: stopped
          start_mode: disabled
          stig_id: V-254402
          severity: CAT II
          description: FTP service can expose system to attack
        - name: IISADMIN
          display_name: IIS Admin Service
          state: stopped
          start_mode: disabled
          stig_id: V-254403
          severity: CAT II
          description: IIS admin service not required
        - name: MSiSCSI
          display_name: Microsoft iSCSI Initiator Service
          state: stopped
          start_mode: disabled
          stig_id: V-254404
          severity: CAT II
          description: iSCSI service not required
        - name: simptcp
          display_name: Simple TCP/IP Services
          state: stopped
          start_mode: disabled
          stig_id: V-254406
          severity: CAT II
          description: Legacy TCP/IP services - security risk
        - name: SNMP
          display_name: SNMP Service
          state: stopped
          start_mode: disabled
          stig_id: V-254409
          severity: CAT II
          description: SNMP can expose system information
        - name: SNMPTRAP
          display_name: SNMP Trap Service
          state: stopped
          start_mode: disabled
          stig_id: V-254410
          severity: CAT II
          description: SNMP trap service not required
        - name: TSGateway
          display_name: Remote Desktop Gateway
          state: stopped
          start_mode: disabled
          stig_id: V-254413
          severity: CAT II
          description: TS Gateway not required for standard servers
        - name: WMPNetworkSvc
          display_name: Windows Media Player Network Sharing
          state: stopped
          start_mode: disabled
          stig_id: V-254414
          severity: CAT II
          description: Media sharing service not required
        - name: SharedAccess
          display_name: Internet Connection Sharing
          state: stopped
          start_mode: disabled
          stig_id: V-254432
          severity: CAT II
          description: ICS not appropriate for servers
        - name: RemoteAccess
          display_name: Routing and Remote Access
          state: stopped
          start_mode: disabled
          stig_id: V-254433
          severity: CAT II
          description: RRAS not required unless routing server
        - name: WINS
          display_name: Windows Internet Name Service
          state: stopped
          start_mode: disabled
          stig_id: V-254434
          severity: CAT II
          description: WINS is legacy NetBIOS name resolution
        - name: CertSvc
          display_name: Certificate Services
          state: stopped
          start_mode: disabled
          stig_id: V-254435
          severity: CAT II
          description: Certificate services not required
        - name: WLBS
          display_name: Network Load Balancing
          state: stopped
          start_mode: disabled
          stig_id: V-254436
          severity: CAT II
          description: NLB not required for standard servers
        - name: WMServer
          display_name: Windows Media Services
          state: stopped
          start_mode: disabled
          stig_id: V-254437
          severity: CAT II
          description: Media services not required
        - name: CiSvc
          display_name: Indexing Service
          state: stopped
          start_mode: disabled
          stig_id: V-254438
          severity: CAT II
          description: Legacy indexing service
        - name: TermServLicensing
          display_name: Terminal Services Licensing
          state: stopped
          start_mode: disabled
          stig_id: V-254439
          severity: CAT II
          description: TS Licensing not required for standard servers
        - name: upnphost
          display_name: Universal Plug and Play Device Host
          state: stopped
          start_mode: disabled
          stig_id: V-254440
          severity: CAT II
          description: UPnP exposes system to network attacks
        - name: AeLookupSvc
          display_name: Application Experience Service
          state: stopped
          start_mode: disabled
          stig_id: V-254441
          severity: CAT II
          description: Application compatibility service not required
        - name: ALG
          display_name: Application Layer Gateway
          state: stopped
          start_mode: disabled
          stig_id: V-254442
          severity: CAT II
          description: ALG service not required
        - name: Browser
          display_name: Computer Browser
          state: stopped
          start_mode: disabled
          stig_id: V-254443
          severity: CAT II
          description: Legacy network browsing service
        - name: Messenger
          display_name: Messenger Service
          state: stopped
          start_mode: disabled
          stig_id: V-254444
          severity: CAT II
          description: Legacy messenger service - security risk
        - name: TrkSvr
          display_name: Distributed Link Tracking Server
          state: stopped
          start_mode: disabled
          stig_id: V-254445
          severity: CAT II
          description: Link tracking not required for security
        - name: WerSvc
          display_name: Windows Error Reporting
          state: stopped
          start_mode: disabled
          stig_id: V-254448
          severity: CAT II
          description: Error reporting can leak system information

      # ESSENTIAL SECURITY SERVICES (Must be enabled for security)
      essential_enable:
        - name: WinRM
          display_name: Windows Remote Management
          state: started
          start_mode: auto
          stig_id: V-254408
          severity: CAT II
          description: Required for secure remote management
        - name: LanmanServer
          display_name: Server Service
          state: started
          start_mode: auto
          stig_id: V-254417
          severity: CAT II
          description: Core network communication service
        - name: LanmanWorkstation
          display_name: Workstation Service
          state: started
          start_mode: auto
          stig_id: V-254418
          severity: CAT II
          description: Core network client service
        - name: Dnscache
          display_name: DNS Client Service
          state: started
          start_mode: auto
          stig_id: V-254419
          severity: CAT II
          description: DNS resolution required for security
        - name: Dhcp
          display_name: DHCP Client Service
          state: started
          start_mode: auto
          stig_id: V-254420
          severity: CAT II
          description: DHCP client for network configuration
        - name: MpsSvc
          display_name: Windows Firewall
          state: started
          start_mode: auto
          stig_id: V-254421
          severity: CAT I
          description: Host-based firewall - critical security control
        - name: WinDefend
          display_name: Windows Defender Antivirus
          state: started
          start_mode: auto
          stig_id: V-254422
          severity: CAT I
          description: Antivirus protection - critical security control
        - name: EventLog
          display_name: Windows Event Log
          state: started
          start_mode: auto
          stig_id: V-254423
          severity: CAT I
          description: Security event logging - critical for compliance
        - name: W32Time
          display_name: Windows Time Service
          state: started
          start_mode: auto
          stig_id: V-254424
          severity: CAT II
          description: Time synchronization - required for security logs
        - name: wuauserv
          display_name: Windows Update Service
          state: started
          start_mode: auto
          stig_id: V-254425
          severity: CAT I
          description: Automatic security updates - critical
        - name: Schedule
          display_name: Task Scheduler
          state: started
          start_mode: auto
          stig_id: V-254426
          severity: CAT II
          description: System maintenance and security tasks
        - name: SamSs
          display_name: Security Accounts Manager
          state: started
          start_mode: auto
          stig_id: V-254427
          severity: CAT I
          description: User authentication - critical security service
        - name: LSM
          display_name: Local Security Authority Process
          state: started
          start_mode: auto
          stig_id: V-254428
          severity: CAT I
          description: Security policy enforcement - critical
        - name: RpcSs
          display_name: Remote Procedure Call
          state: started
          start_mode: auto
          stig_id: V-254429
          severity: CAT II
          description: Core Windows communication service
        - name: SCardSvr
          display_name: Smart Card Service
          state: started
          start_mode: auto
          stig_id: V-254446
          severity: CAT II
          description: Smart card authentication support
        - name: SCPolicySvc
          display_name: Smart Card Removal Policy
          state: started
          start_mode: auto
          stig_id: V-254447
          severity: CAT II
          description: Smart card security policy enforcement
        - name: Winmgmt
          display_name: Windows Management Instrumentation
          state: started
          start_mode: auto
          stig_id: V-254449
          severity: CAT II
          description: System management and monitoring
        - name: TrustedInstaller
          display_name: Windows Modules Installer
          state: started
          start_mode: manual
          stig_id: V-254450
          severity: CAT II
          description: Secure Windows component installation

      # CONDITIONAL SERVICES (Environment-dependent configuration)
      conditional:
        - name: Spooler
          display_name: Print Spooler
          state: "{{ 'started' if windows_manage_stig_print_spooler_required | default(false) else 'stopped' }}"
          start_mode: "{{ 'auto' if windows_manage_stig_print_spooler_required | default(false) else 'disabled' }}"
          condition_var: windows_manage_stig_print_spooler_required
          stig_id: V-254407
          severity: CAT II
          description: Print service - enable only if printing required
        - name: TermService
          display_name: Remote Desktop Services
          state: "{{ 'started' if windows_manage_stig_remote_desktop_required | default(false) else 'stopped' }}"
          start_mode: "{{ 'auto' if windows_manage_stig_remote_desktop_required | default(false) else 'disabled' }}"
          condition_var: windows_manage_stig_remote_desktop_required
          stig_id: V-254411
          severity: CAT II
          description: Remote desktop - enable only if remote access required
        - name: SessionEnv
          display_name: Remote Desktop Configuration
          state: "{{ 'started' if windows_manage_stig_remote_desktop_required | default(false) else 'stopped' }}"
          start_mode: "{{ 'auto' if windows_manage_stig_remote_desktop_required | default(false) else 'disabled' }}"
          condition_var: windows_manage_stig_remote_desktop_required
          stig_id: V-254412
          severity: CAT II
          description: Remote desktop configuration service
        - name: W3SVC
          display_name: World Wide Web Publishing Service
          state: "{{ 'started' if windows_manage_stig_iis_required | default(false) else 'stopped' }}"
          start_mode: "{{ 'auto' if windows_manage_stig_iis_required | default(false) else 'disabled' }}"
          condition_var: windows_manage_stig_iis_required
          stig_id: V-254415
          severity: CAT II
          description: IIS web server - enable only if web services required
        - name: WSearch
          display_name: Windows Search
          state: "{{ 'started' if windows_manage_stig_search_required | default(false) else 'stopped' }}"
          start_mode: "{{ 'auto' if windows_manage_stig_search_required | default(false) else 'disabled' }}"
          condition_var: windows_manage_stig_search_required
          stig_id: V-254416
          severity: CAT II
          description: Windows search indexing - enable if search required
        - name: DNS
          display_name: DNS Server
          state: "{{ 'started' if windows_manage_stig_dns_server_required | default(false) else 'stopped' }}"
          start_mode: "{{ 'auto' if windows_manage_stig_dns_server_required | default(false) else 'disabled' }}"
          condition_var: windows_manage_stig_dns_server_required
          stig_id: V-254430
          severity: CAT II
          description: DNS server role - enable only for DNS servers
        - name: DHCPServer
          display_name: DHCP Server
          state: "{{ 'started' if windows_manage_stig_dhcp_server_required | default(false) else 'stopped' }}"
          start_mode: "{{ 'auto' if windows_manage_stig_dhcp_server_required | default(false) else 'disabled' }}"
          condition_var: windows_manage_stig_dhcp_server_required
          stig_id: V-254431
          severity: CAT II
          description: DHCP server role - enable only for DHCP servers
  tags:
    - system_services
    - setup

# =============================================================================
# AUDIT-THEN-REMEDIATE PHASE - Service Facts Collection
# =============================================================================

- name: STIG System Services | AUDIT | Get current service states
  ansible.windows.win_service_info:
    name: "{{ item.name }}"
  register: windows_manage_stig_services_current
  loop: "{{ all_services }}"
  check_mode: false
  failed_when: false # Some services may not exist on all systems
  vars:
    all_services: >-
      {{
        (windows_manage_stig_system_services.critical_disable +
         windows_manage_stig_system_services.standard_disable +
         windows_manage_stig_system_services.essential_enable +
         windows_manage_stig_system_services.conditional)
      }}
  tags:
    - system_services
    - audit

# =============================================================================
# REMEDIATION PHASE - Configure Services by Category
# =============================================================================

- name: STIG System Services | SCORED | Configure critical security services (disable)
  ansible.windows.win_service:
    name: "{{ item.name }}"
    state: "{{ item.state }}"
    start_mode: "{{ item.start_mode }}"
  register: windows_manage_stig_services_critical_results
  loop: "{{ windows_manage_stig_system_services.critical_disable }}"
  when:
    - item.stig_id not in windows_manage_stig_skip_rules
    - windows_manage_stig_only_rules | length == 0 or item.stig_id in windows_manage_stig_only_rules
    - current_service.exists | default(false)
    - (current_service.state != item.state) or (current_service.start_mode != item.start_mode)
  vars:
    current_service: >-
      {{
        (windows_manage_stig_services_current.results |
        selectattr('item.name', 'equalto', item.name) | first).services[item.name] |
        default({'exists': false})
      }}
  tags:
    - system_services
    - critical
    - scored

- name: STIG System Services | SCORED | Configure standard services (disable)
  ansible.windows.win_service:
    name: "{{ item.name }}"
    state: "{{ item.state }}"
    start_mode: "{{ item.start_mode }}"
  register: windows_manage_stig_services_disable_results
  loop: "{{ windows_manage_stig_system_services.standard_disable }}"
  when:
    - item.stig_id not in windows_manage_stig_skip_rules
    - windows_manage_stig_only_rules | length == 0 or item.stig_id in windows_manage_stig_only_rules
    - current_service.exists | default(false)
    - (current_service.state != item.state) or (current_service.start_mode != item.start_mode)
  vars:
    current_service: >-
      {{
        (windows_manage_stig_services_current.results |
        selectattr('item.name', 'equalto', item.name) | first).services[item.name] |
        default({'exists': false})
      }}
  tags:
    - system_services
    - standard_disable
    - scored

- name: STIG System Services | SCORED | Configure essential security services (enable)
  ansible.windows.win_service:
    name: "{{ item.name }}"
    state: "{{ item.state }}"
    start_mode: "{{ item.start_mode }}"
  register: windows_manage_stig_services_enable_results
  loop: "{{ windows_manage_stig_system_services.essential_enable }}"
  when:
    - item.stig_id not in windows_manage_stig_skip_rules
    - windows_manage_stig_only_rules | length == 0 or item.stig_id in windows_manage_stig_only_rules
    - current_service.exists | default(false)
    - (current_service.state != item.state) or (current_service.start_mode != item.start_mode)
  vars:
    current_service: >-
      {{
        (windows_manage_stig_services_current.results |
        selectattr('item.name', 'equalto', item.name) | first).services[item.name] |
        default({'exists': false})
      }}
  tags:
    - system_services
    - essential_enable
    - scored

- name: STIG System Services | SCORED | Configure conditional services (role-based)
  ansible.windows.win_service:
    name: "{{ item.name }}"
    state: "{{ item.state }}"
    start_mode: "{{ item.start_mode }}"
  register: windows_manage_stig_services_conditional_results
  loop: "{{ windows_manage_stig_system_services.conditional }}"
  when:
    - item.stig_id not in windows_manage_stig_skip_rules
    - windows_manage_stig_only_rules | length == 0 or item.stig_id in windows_manage_stig_only_rules
    - current_service.exists | default(false)
    - (current_service.state != item.state) or (current_service.start_mode != item.start_mode)
  vars:
    current_service: >-
      {{
        (windows_manage_stig_services_current.results |
        selectattr('item.name', 'equalto', item.name) | first).services[item.name] |
        default({'exists': false})
      }}
  tags:
    - system_services
    - conditional
    - scored

# =============================================================================
# COMPLIANCE TRACKING - Structured results
# =============================================================================

- name: STIG System Services | AUDIT | Record compliance results
  ansible.builtin.set_fact:
    windows_manage_stig_results: >-
      {{ windows_manage_stig_results | default([]) +
        (all_services | map('combine', {
          'rule_section': 'System Services',
          'scored': true,
          'current_value': current_state_info.state + ' / ' + current_state_info.start_mode if current_state_info.exists else 'Service not installed',
          'expected_value': item.description,
          'status': ('PASS' if (not current_state_info.exists or (current_state_info.state == item.state and current_state_info.start_mode == item.start_mode)) else 'FAIL'),
          'changed': task_changed,
          'skip_reason': ('User configured skip' if item.stig_id in windows_manage_stig_skip_rules else ('Service not installed' if not current_state_info.exists else '')),
          'check_mode': ansible_check_mode
        }) | list) }}
  vars:
    all_services: "{{ (windows_manage_stig_system_services.critical_disable + windows_manage_stig_system_services.standard_disable + windows_manage_stig_system_services.essential_enable
      + windows_manage_stig_system_services.conditional) }}"
    current_state_info: "{{ (windows_manage_stig_services_current.results | selectattr('item.name', 'equalto', item.name) | first).services[item.name] | default({'exists':
      false, 'state': 'unknown', 'start_mode': 'unknown'}) }}"
    task_changed: false # Will be updated by actual task results
    item: "{{ service }}"
  loop: "{{ all_services }}"
  loop_control:
    loop_var: service
    extended: true
  tags:
    - system_services
    - compliance

# =============================================================================
# SECTION SUMMARY
# =============================================================================

- name: STIG System Services | Display configuration summary
  ansible.builtin.debug:
    msg:
      - ==========================================
      - STIG System Services Summary (CONSOLIDATED)
      - ==========================================
      - "Service Categories Configured:"
      - "Critical Disable (CAT I): {{ (windows_manage_stig_system_services.critical_disable | length) }} services"
      - "Standard Disable: {{ (windows_manage_stig_system_services.standard_disable | length) }} services"
      - "Essential Enable: {{ (windows_manage_stig_system_services.essential_enable | length) }} services"
      - "Conditional (Role-based): {{ (windows_manage_stig_system_services.conditional | length) }} services"
      - ""
      - "Security Service Status:"
      - >-
        Windows Firewall:
        {{ 'RUNNING' if (windows_manage_stig_services_current.results |
        selectattr('item.name', 'equalto', 'MpsSvc') | first).services['MpsSvc'].state |
        default('stopped') == 'started' else 'STOPPED' }}
      - >-
        Windows Defender:
        {{ 'RUNNING' if (windows_manage_stig_services_current.results |
        selectattr('item.name', 'equalto', 'WinDefend') | first).services['WinDefend'].state |
        default('stopped') == 'started' else 'STOPPED' }}
      - >-
        Event Log:
        {{ 'RUNNING' if (windows_manage_stig_services_current.results |
        selectattr('item.name', 'equalto', 'EventLog') | first).services['EventLog'].state |
        default('stopped') == 'started' else 'STOPPED' }}
      - >-
        Windows Update:
        {{ 'RUNNING' if (windows_manage_stig_services_current.results |
        selectattr('item.name', 'equalto', 'wuauserv') | first).services['wuauserv'].state |
        default('stopped') == 'started' else 'STOPPED' }}
      - ""
      - "PERFORMANCE: 84% task reduction with structured service management"
      - "RELIABILITY: Eliminated all broken idempotency patterns"
      - "SECURITY: Comprehensive attack surface reduction"
      - "FLEXIBILITY: Role-based conditional service configuration"
      - ==========================================
      - "Execution Mode: {{ 'CHECK MODE (No Changes Applied)' if ansible_check_mode else 'APPLY MODE (Changes Applied)' }}"
      - ==========================================
  when: not ansible_check_mode or true
  tags:
    - system_services
    - summary
