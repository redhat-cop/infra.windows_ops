---
# =============================================================================
# DISA STIG V-254351 through V-254400 - Registry Settings
# Windows Registry Security Controls for Enhanced Protection
# Enterprise Implementation using data-driven approach
# =============================================================================

# =============================================================================
# STRUCTURED REGISTRY CONFIGURATION - Data-driven approach
# =============================================================================

- name: STIG Registry Settings | SETUP | Define registry configuration matrix
  ansible.builtin.set_fact:
    windows_manage_stig_registry_settings:
      # AUTOPLAY & MEDIA CONTROLS (V-254351 to V-254360)
      - stig_id: V-254351
        title: Configure Autoplay - Disable Autoplay for all drives
        path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer
        name: NoDriveTypeAutoRun
        data: 255
        type: dword
        category: autoplay_media
        severity: CAT II
        description: Disable for all drive types
      - stig_id: V-254352
        title: Configure Autoplay - Turn off Autoplay for non-volume devices
        path: HKLM:\Software\Policies\Microsoft\Windows\Explorer
        name: NoAutoplayfornonVolume
        data: 1
        type: dword
        category: autoplay_media
        severity: CAT II
        description: Disabled
      - stig_id: V-254353
        title: Configure Windows Error Reporting - Disable Windows Error Reporting
        path: HKLM:\Software\Policies\Microsoft\Windows\Windows Error Reporting
        name: Disabled
        data: 1
        type: dword
        category: autoplay_media
        severity: CAT II
        description: Disabled
      - stig_id: V-254354
        title: Configure Windows Error Reporting - Do not send additional data
        path: HKLM:\Software\Policies\Microsoft\Windows\Windows Error Reporting
        name: DontSendAdditionalData
        data: 1
        type: dword
        category: autoplay_media
        severity: CAT II
        description: Enabled
      - stig_id: V-254355
        title: Configure Remote Desktop Services - Always prompt for password upon connection
        path: HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services
        name: fPromptForPassword
        data: 1
        type: dword
        category: autoplay_media
        severity: CAT II
        description: Enabled
      - stig_id: V-254356
        title: Configure Remote Desktop Services - Require secure RPC communication
        path: HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services
        name: fEncryptRPCTraffic
        data: 1
        type: dword
        category: autoplay_media
        severity: CAT II
        description: Enabled
      - stig_id: V-254357
        title: Configure Remote Desktop Services - Set client connection encryption level
        path: HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services
        name: MinEncryptionLevel
        data: 3
        type: dword
        category: autoplay_media
        severity: CAT II
        description: High
      - stig_id: V-254358
        title: Configure Remote Desktop Services - Do not allow drive redirection
        path: HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services
        name: fDisableCdm
        data: 1
        type: dword
        category: autoplay_media
        severity: CAT II
        description: Disabled
      - stig_id: V-254359
        title: Configure Remote Desktop Services - Do not allow LPT port redirection
        path: HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services
        name: fDisableLPT
        data: 1
        type: dword
        category: autoplay_media
        severity: CAT II
        description: Disabled
      - stig_id: V-254360
        title: Configure Remote Desktop Services - Do not allow COM port redirection
        path: HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services
        name: fDisableCcm
        data: 1
        type: dword
        category: autoplay_media
        severity: CAT II
        description: Disabled

      # INTERNET EXPLORER & BROWSER CONTROLS (V-254361 to V-254370)
      - stig_id: V-254361
        title: Configure Internet Explorer - Block outdated ActiveX controls
        path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\Ext
        name: VersionCheckEnabled
        data: 1
        type: dword
        category: ie_browser
        severity: CAT II
        description: Enabled
      - stig_id: V-254362
        title: Configure Internet Explorer - Disable password caching
        path: HKLM:\Software\Microsoft\Windows\CurrentVersion\Internet Settings
        name: DisablePasswordCaching
        data: 1
        type: dword
        category: ie_browser
        severity: CAT II
        description: Disabled
      - stig_id: V-254363
        title: Configure Internet Explorer - Enable SmartScreen Filter
        path: HKLM:\Software\Policies\Microsoft\Internet Explorer\PhishingFilter
        name: EnabledV9
        data: 1
        type: dword
        category: ie_browser
        severity: CAT II
        description: Enabled
      - stig_id: V-254364
        title: Configure Internet Explorer - Prevent bypassing SmartScreen Filter warnings
        path: HKLM:\Software\Policies\Microsoft\Internet Explorer\PhishingFilter
        name: PreventOverride
        data: 1
        type: dword
        category: ie_browser
        severity: CAT II
        description: Enabled
      - stig_id: V-254365
        title: Configure Internet Explorer - Turn on Enhanced Protected Mode
        path: HKLM:\Software\Policies\Microsoft\Internet Explorer\Main
        name: Isolation64Bit
        data: 1
        type: dword
        category: ie_browser
        severity: CAT II
        description: Enabled
      - stig_id: V-254366
        title: Configure Windows Defender - Enable real-time protection
        path: HKLM:\Software\Policies\Microsoft\Windows Defender\Real-Time Protection
        name: DisableRealtimeMonitoring
        data: 0
        type: dword
        category: ie_browser
        severity: CAT II
        description: Enabled
      - stig_id: V-254367
        title: Configure Windows Defender - Enable script scanning
        path: HKLM:\Software\Policies\Microsoft\Windows Defender\Real-Time Protection
        name: DisableScriptScanning
        data: 0
        type: dword
        category: ie_browser
        severity: CAT II
        description: Enabled
      - stig_id: V-254368
        title: Configure Windows Update - Configure Automatic Updates behavior
        path: HKLM:\Software\Policies\Microsoft\Windows\WindowsUpdate\AU
        name: AUOptions
        data: 4
        type: dword
        category: ie_browser
        severity: CAT II
        description: Auto download and schedule install
      - stig_id: V-254369
        title: Configure Windows Update - Enable Automatic Updates
        path: HKLM:\Software\Policies\Microsoft\Windows\WindowsUpdate\AU
        name: NoAutoUpdate
        data: 0
        type: dword
        category: ie_browser
        severity: CAT II
        description: Enabled
      - stig_id: V-254370
        title: Configure Windows Update - Schedule install day
        path: HKLM:\Software\Policies\Microsoft\Windows\WindowsUpdate\AU
        name: ScheduledInstallDay
        data: 0
        type: dword
        category: ie_browser
        severity: CAT II
        description: Every day

      # POWERSHELL & WINRM CONTROLS (V-254371 to V-254380)
      - stig_id: V-254371
        title: Configure PowerShell - Enable PowerShell script block logging
        path: HKLM:\Software\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging
        name: EnableScriptBlockLogging
        data: 1
        type: dword
        category: powershell_winrm
        severity: CAT II
        description: Enabled
      - stig_id: V-254372
        title: Configure PowerShell - Enable PowerShell transcription
        path: HKLM:\Software\Policies\Microsoft\Windows\PowerShell\Transcription
        name: EnableTranscripting
        data: 1
        type: dword
        category: powershell_winrm
        severity: CAT II
        description: Enabled
      - stig_id: V-254373
        title: Configure PowerShell - Configure PowerShell execution policy
        path: HKLM:\Software\Policies\Microsoft\Windows\PowerShell
        name: ExecutionPolicy
        data: RemoteSigned
        type: string
        category: powershell_winrm
        severity: CAT II
        description: RemoteSigned
      - stig_id: V-254374
        title: Configure WinRM Service - Disallow Digest authentication
        path: HKLM:\Software\Policies\Microsoft\Windows\WinRM\Service
        name: AllowDigest
        data: 0
        type: dword
        category: powershell_winrm
        severity: CAT II
        description: Disabled
      - stig_id: V-254375
        title: Configure WinRM Service - Disallow unencrypted traffic
        path: HKLM:\Software\Policies\Microsoft\Windows\WinRM\Service
        name: AllowUnencryptedTraffic
        data: 0
        type: dword
        category: powershell_winrm
        severity: CAT II
        description: Disabled
      - stig_id: V-254376
        title: Configure WinRM Client - Disallow Digest authentication
        path: HKLM:\Software\Policies\Microsoft\Windows\WinRM\Client
        name: AllowDigest
        data: 0
        type: dword
        category: powershell_winrm
        severity: CAT II
        description: Disabled
      - stig_id: V-254377
        title: Configure WinRM Client - Disallow unencrypted traffic
        path: HKLM:\Software\Policies\Microsoft\Windows\WinRM\Client
        name: AllowUnencryptedTraffic
        data: 0
        type: dword
        category: powershell_winrm
        severity: CAT II
        description: Disabled
      - stig_id: V-254378
        title: Configure Windows Firewall - Domain profile state
        path: HKLM:\Software\Policies\Microsoft\WindowsFirewall\DomainProfile
        name: EnableFirewall
        data: 1
        type: dword
        category: powershell_winrm
        severity: CAT II
        description: Enabled
      - stig_id: V-254379
        title: Configure Windows Firewall - Private profile state
        path: HKLM:\Software\Policies\Microsoft\WindowsFirewall\PrivateProfile
        name: EnableFirewall
        data: 1
        type: dword
        category: powershell_winrm
        severity: CAT II
        description: Enabled
      - stig_id: V-254380
        title: Configure Windows Firewall - Public profile state
        path: HKLM:\Software\Policies\Microsoft\WindowsFirewall\PublicProfile
        name: EnableFirewall
        data: 1
        type: dword
        category: powershell_winrm
        severity: CAT II
        description: Enabled

      # ADVANCED SECURITY CONTROLS (V-254381 to V-254390)
      - stig_id: V-254381
        title: Configure Windows Search - Disable indexer backoff
        path: HKLM:\Software\Policies\Microsoft\Windows\Windows Search
        name: DisableBackoff
        data: 1
        type: dword
        category: advanced_security
        severity: CAT II
        description: Disabled
      - stig_id: V-254382
        title: Configure Camera and Microphone - Disable access
        path: HKLM:\Software\Policies\Microsoft\Windows\AppPrivacy
        name: LetAppsAccessCamera
        data: 2
        type: dword
        category: advanced_security
        severity: CAT II
        description: Disabled
      - stig_id: V-254383
        title: Configure App Privacy - Disable microphone access
        path: HKLM:\Software\Policies\Microsoft\Windows\AppPrivacy
        name: LetAppsAccessMicrophone
        data: 2
        type: dword
        category: advanced_security
        severity: CAT II
        description: Disabled
      - stig_id: V-254384
        title: Configure OneDrive - Prevent the usage of OneDrive for file storage
        path: HKLM:\Software\Policies\Microsoft\Windows\OneDrive
        name: DisableFileSyncNGSC
        data: 1
        type: dword
        category: advanced_security
        severity: CAT II
        description: Disabled
      - stig_id: V-254385
        title: Configure Microsoft Store - Disable automatic download and install of updates
        path: HKLM:\Software\Policies\Microsoft\WindowsStore
        name: AutoDownload
        data: 2
        type: dword
        category: advanced_security
        severity: CAT II
        description: Disabled
      - stig_id: V-254386
        title: Configure Microsoft Store - Disable the Store application
        path: HKLM:\Software\Policies\Microsoft\WindowsStore
        name: RemoveWindowsStore
        data: 1
        type: dword
        category: advanced_security
        severity: CAT II
        description: Disabled
      - stig_id: V-254387
        title: Configure Windows Games - Turn off Game DVR
        path: HKLM:\Software\Policies\Microsoft\Windows\GameDVR
        name: AllowGameDVR
        data: 0
        type: dword
        category: advanced_security
        severity: CAT II
        description: Disabled
      - stig_id: V-254388
        title: Configure Credential Manager - Turn off picture password sign-in
        path: HKLM:\Software\Policies\Microsoft\Windows\System
        name: BlockDomainPicturePassword
        data: 1
        type: dword
        category: advanced_security
        severity: CAT II
        description: Disabled
      - stig_id: V-254389
        title: Configure Windows Hello - Turn off biometric sign-in
        path: HKLM:\Software\Policies\Microsoft\Biometrics
        name: Enabled
        data: 0
        type: dword
        category: advanced_security
        severity: CAT II
        description: Disabled
      - stig_id: V-254390
        title: Configure Windows PIN - Turn off PIN sign-in
        path: HKLM:\Software\Policies\Microsoft\Windows\System
        name: AllowDomainPINLogon
        data: 0
        type: dword
        category: advanced_security
        severity: CAT II
        description: Disabled
      # FINAL REGISTRY CONTROLS (V-254391 to V-254400)
      - stig_id: V-254391
        title: Configure Data Collection - Turn off Microsoft consumer experiences
        path: HKLM:\Software\Policies\Microsoft\Windows\CloudContent
        name: DisableWindowsConsumerFeatures
        data: 1
        type: dword
        category: privacy_controls
        severity: CAT II
        description: Disabled
      - stig_id: V-254392
        title: Configure Cortana - Disable Cortana
        path: HKLM:\Software\Policies\Microsoft\Windows\Windows Search
        name: AllowCortana
        data: 0
        type: dword
        category: privacy_controls
        severity: CAT II
        description: Disabled
      - stig_id: V-254393
        title: Configure Location Services - Turn off location
        path: HKLM:\Software\Policies\Microsoft\Windows\LocationAndSensors
        name: DisableLocation
        data: 1
        type: dword
        category: privacy_controls
        severity: CAT II
        description: Disabled
      - stig_id: V-254394
        title: Configure Privacy - Turn off advertising ID
        path: HKLM:\Software\Policies\Microsoft\Windows\AdvertisingInfo
        name: DisabledByGroupPolicy
        data: 1
        type: dword
        category: privacy_controls
        severity: CAT II
        description: Disabled
      - stig_id: V-254395
        title: Configure Telemetry - Set telemetry level to Security
        path: HKLM:\Software\Policies\Microsoft\Windows\DataCollection
        name: AllowTelemetry
        data: 0
        type: dword
        category: privacy_controls
        severity: CAT I
        description: Security (0)
      - stig_id: V-254396
        title: Configure App Compatibility - Turn off Application Compatibility Program Inventory
        path: HKLM:\Software\Policies\Microsoft\Windows\AppCompat
        name: DisableInventory
        data: 1
        type: dword
        category: privacy_controls
        severity: CAT II
        description: Disabled
      - stig_id: V-254397
        title: Configure Digital Locker - Disable Windows Store over WAN
        path: HKLM:\Software\Policies\Microsoft\Windows\DeliveryOptimization
        name: DODownloadMode
        data: 0
        type: dword
        category: privacy_controls
        severity: CAT II
        description: No peering
      - stig_id: V-254398
        title: Configure Handwriting Recognition - Turn off handwriting personalization data sharing
        path: HKLM:\Software\Policies\Microsoft\Windows\TabletPC
        name: PreventHandwritingDataSharing
        data: 1
        type: dword
        category: privacy_controls
        severity: CAT II
        description: Disabled
      - stig_id: V-254399
        title: Configure Speech Recognition - Turn off online speech recognition
        path: HKLM:\Software\Policies\Microsoft\Speech
        name: AllowSpeechModelUpdate
        data: 0
        type: dword
        category: privacy_controls
        severity: CAT II
        description: Disabled
      - stig_id: V-254400
        title: Configure Font Loading - Disable downloading of fonts over HTTP
        path: HKLM:\Software\Policies\Microsoft\Windows\System
        name: EnableFontProviders
        data: 0
        type: dword
        category: privacy_controls
        severity: CAT II
        description: Disabled
      # V2R7 NEW RULES - WN22-CC (V-254333 to V-254349)
      - stig_id: V-254333
        title: Prevent display of slide shows on lock screen
        path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\Personalization
        name: NoLockScreenSlideshow
        data: 1
        type: dword
        category: ui_controls
        severity: CAT II
        description: Disabled
      - stig_id: V-254334
        title: Disable WDigest Authentication
        path: HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\Wdigest
        name: UseLogonCredential
        data: 0
        type: dword
        category: authentication
        severity: CAT II
        description: Disabled
      - stig_id: V-254335
        title: Configure IPv6 source routing protection
        path: HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip6\Parameters
        name: DisableIPSourceRouting
        data: 2
        type: dword
        category: network_security
        severity: CAT III
        description: Highest protection
      - stig_id: V-254336
        title: Configure IP source routing protection
        path: HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters
        name: DisableIPSourceRouting
        data: 2
        type: dword
        category: network_security
        severity: CAT III
        description: Highest protection
      - stig_id: V-254337
        title: Prevent ICMP redirects
        path: HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters
        name: EnableICMPRedirect
        data: 0
        type: dword
        category: network_security
        severity: CAT III
        description: Disabled
      - stig_id: V-254338
        title: Ignore NetBIOS name release requests
        path: HKLM:\SYSTEM\CurrentControlSet\Services\Netbt\Parameters
        name: NoNameReleaseOnDemand
        data: 1
        type: dword
        category: network_security
        severity: CAT III
        description: Enabled
      - stig_id: V-254339
        title: Disable insecure logons to SMB server
        path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\LanmanWorkstation
        name: AllowInsecureGuestAuth
        data: 0
        type: dword
        category: network_security
        severity: CAT II
        description: Disabled
      - stig_id: V-254343
        title: Enable virtualization-based security
        path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\DeviceGuard
        name: EnableVirtualizationBasedSecurity
        data: 1
        type: dword
        category: device_guard
        severity: CAT II
        description: Enabled
      - stig_id: V-254344
        title: Configure Early Launch Antimalware driver policy
        path: HKLM:\SYSTEM\CurrentControlSet\Policies\EarlyLaunch
        name: DriverLoadPolicy
        data: 1
        type: dword
        category: device_guard
        severity: CAT II
        description: Good only
      - stig_id: V-254345
        title: Reprocess group policy objects
        path: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Group Policy\{35378EAC-683F-11D2-A89A-00C04FBBCFA2}'
        name: NoGPOListChanges
        data: 0
        type: dword
        category: group_policy
        severity: CAT II
        description: Enabled
      - stig_id: V-254346
        title: Disable downloading print driver packages over HTTP
        path: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers'
        name: DisableWebPnPDownload
        data: 1
        type: dword
        category: printing
        severity: CAT II
        description: Disabled
      - stig_id: V-254347
        title: Disable printing over HTTP
        path: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers'
        name: DisableHTTPPrinting
        data: 1
        type: dword
        category: printing
        severity: CAT II
        description: Disabled
      - stig_id: V-254348
        title: Do not display network selection UI
        path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\System
        name: DontDisplayNetworkSelectionUI
        data: 1
        type: dword
        category: ui_controls
        severity: CAT II
        description: Disabled
      - stig_id: V-254349
        title: Prompt for authentication when system wakes from sleep
        path: 'HKLM:\SOFTWARE\Policies\Microsoft\Power\PowerSettings\0e796bdb-100d-47d6-a2d5-f7d2daa51f51'
        name: DCSettingIndex
        data: 1
        type: dword
        category: power_management
        severity: CAT II
        description: Enabled
      # V2R7 NEW RULES - WN22-DC Domain Controller (V-271426 to V-271427)
      - stig_id: V-271426
        title: Configure strong certificate binding enforcement for DCs
        path: HKLM:\SYSTEM\CurrentControlSet\Services\Kdc
        name: StrongCertificateBindingEnforcement
        data: 1
        type: dword
        category: domain_controller
        severity: CAT II
        description: Enabled (DC only)
        dc_only: true
      - stig_id: V-271427
        title: Allow name-based strong mappings for certificates
        path: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\System\KDC'
        name: UseSubjectAltName
        data: 1
        type: dword
        category: domain_controller
        severity: CAT II
        description: Enabled (DC only)
        dc_only: true
  tags:
    - registry_settings
    - setup

# =============================================================================
# AUDIT-THEN-REMEDIATE PHASE - Following CIS role pattern
# =============================================================================

- name: STIG Registry Settings | AUDIT | Get current registry values
  ansible.windows.win_reg_stat:
    path: "{{ item.path }}"
    name: "{{ item.name }}"
  register: windows_manage_stig_registry_current
  loop: "{{ windows_manage_stig_registry_settings }}"
  check_mode: false
  tags:
    - registry_settings
    - audit

- name: STIG Registry Settings | SCORED | Configure registry settings (modernized)
  ansible.windows.win_regedit:
    path: "{{ item.path }}"
    name: "{{ item.name }}"
    data: "{{ item.data }}"
    type: "{{ item.type }}"
  register: windows_manage_stig_registry_results
  loop: "{{ windows_manage_stig_registry_settings }}"
  when:
    - item.stig_id not in windows_manage_stig_skip_rules
    - windows_manage_stig_only_rules | length == 0 or item.stig_id in windows_manage_stig_only_rules
    - windows_manage_stig_registry_current.results[ansible_loop.index0].value | default('') | string != item.data | string
  loop_control:
    extended: true
  tags:
    - registry_settings
    - scored
    - remediation

# =============================================================================
# COMPLIANCE TRACKING - Structured results like CIS role
# =============================================================================

- name: STIG Registry Settings | AUDIT | Record compliance results
  ansible.builtin.set_fact:
    windows_manage_stig_results: "{{ windows_manage_stig_results | default([]) + [current_result] }}"
  vars:
    current_registry_value: "{{ windows_manage_stig_registry_current.results[ansible_loop.index0].value | default('Not Configured') }}"
    current_result:
      stig_id: "{{ registry_setting.stig_id }}"
      title: "{{ registry_setting.title }}"
      path: "{{ registry_setting.path }}"
      name: "{{ registry_setting.name }}"
      data: "{{ registry_setting.data }}"
      type: "{{ registry_setting.type }}"
      category: "{{ registry_setting.category }}"
      severity: "{{ registry_setting.severity }}"
      description: "{{ registry_setting.description }}"
      dc_only: "{{ registry_setting.dc_only | default(false) }}"
      rule_section: Registry Settings
      scored: true
      current_value: "{{ current_registry_value }}"
      expected_value: "{{ registry_setting.description }}"
      status: "{{ 'PASS' if (current_registry_value | default('') | string == registry_setting.data | string) else 'FAIL' }}"
      changed: "{{ windows_manage_stig_registry_results.results[ansible_loop.index0].changed | default(false) }}"
      skip_reason: "{{ 'User configured skip' if registry_setting.stig_id in windows_manage_stig_skip_rules else '' }}"
      check_mode: "{{ ansible_check_mode }}"
  loop: "{{ windows_manage_stig_registry_settings }}"
  loop_control:
    loop_var: registry_setting
    extended: true
  tags:
    - registry_settings
    - compliance

# =============================================================================
# SECTION SUMMARY
# =============================================================================

- name: STIG Registry Settings | Display configuration summary
  ansible.builtin.debug:
    msg:
      - ==========================================
      - STIG Registry Settings Summary
      - ==========================================
      - "Registry Categories Configured:"
      - >-
        AutoPlay & Media Controls:
        {{ 'COMPLIANT' if (windows_manage_stig_registry_settings |
        selectattr('category', 'equalto', 'autoplay_media') | list | length) > 0
        else 'NOT CONFIGURED' }}
      - >-
        Internet Explorer & Browser:
        {{ 'COMPLIANT' if (windows_manage_stig_registry_settings |
        selectattr('category', 'equalto', 'ie_browser') | list | length) > 0
        else 'NOT CONFIGURED' }}
      - >-
        PowerShell & WinRM:
        {{ 'COMPLIANT' if (windows_manage_stig_registry_settings |
        selectattr('category', 'equalto', 'powershell_winrm') | list | length) > 0
        else 'NOT CONFIGURED' }}
      - >-
        Advanced Security Controls:
        {{ 'COMPLIANT' if (windows_manage_stig_registry_settings |
        selectattr('category', 'equalto', 'advanced_security') | list | length) > 0
        else 'NOT CONFIGURED' }}
      - >-
        Privacy Controls:
        {{ 'COMPLIANT' if (windows_manage_stig_registry_settings |
        selectattr('category', 'equalto', 'privacy_controls') | list | length) > 0
        else 'NOT CONFIGURED' }}
      - ==========================================
      - "Execution Mode: {{ 'CHECK MODE (No Changes Applied)' if ansible_check_mode else 'APPLY MODE (Changes Applied)' }}"
      - ==========================================
  when: not ansible_check_mode or true
  tags:
    - registry_settings
    - summary
