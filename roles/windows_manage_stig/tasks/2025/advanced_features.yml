---
# =============================================================================
# Windows Server 2025 Advanced Features - DISA STIG Controls
# DNS-over-HTTPS, SMB over QUIC, TLS 1.3, Hotpatching, Credential Guard, AD 32k
# =============================================================================

# =============================================================================
# DNS-OVER-HTTPS CONFIGURATION (2022+)
# =============================================================================

- name: STIG 2022+ | DNS-over-HTTPS | Check current configuration
  when:
    - windows_manage_stig_only_rules | length == 0 or 'V-DNS-HTTPS' in windows_manage_stig_only_rules
  ansible.windows.win_reg_stat:
    path: HKLM:\SYSTEM\CurrentControlSet\Services\Dnscache\Parameters
    name: EnableDnsOverHttps
  register: windows_manage_stig_doh_current_status
  tags:
    - dns_over_https
    - version_2022_plus
    - stig

- name: STIG 2022+ | DNS-over-HTTPS | Enable DoH
  when:
    - windows_manage_stig_dns_over_https_enabled | default(true)
    - windows_manage_stig_only_rules | length == 0 or 'V-DNS-HTTPS' in windows_manage_stig_only_rules
    - not windows_manage_stig_doh_current_status.exists or windows_manage_stig_doh_current_status.value != windows_manage_stig_dns_over_https_mode | default(2)
  ansible.windows.win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Services\Dnscache\Parameters
    name: EnableDnsOverHttps
    data: "{{ windows_manage_stig_dns_over_https_mode | default(2) }}"
    type: dword
  register: windows_manage_stig_doh_configured

- name: STIG 2022+ | DNS-over-HTTPS | Record compliance result
  when:
    - windows_manage_stig_only_rules | length == 0 or 'V-DNS-HTTPS' in windows_manage_stig_only_rules
  ansible.builtin.set_fact:
    windows_manage_stig_results: >-
      {{ windows_manage_stig_results | default([]) + [{
        'stig_id': 'V-DNS-HTTPS',
        'title': 'DNS-over-HTTPS must be enabled to protect DNS queries',
        'rule_section': 'Network Security',
        'severity': 'CAT II',
        'scored': true,
        'current_value': (windows_manage_stig_doh_current_status.value | default(0) | string) if windows_manage_stig_doh_current_status.exists else 'Not Configured',
        'expected_value': (windows_manage_stig_dns_over_https_mode | default(2) | string),
        'status': 'PASS' if (windows_manage_stig_doh_current_status.exists and windows_manage_stig_doh_current_status.value == (windows_manage_stig_dns_over_https_mode | default(2))) or (windows_manage_stig_doh_configured.changed | default(false)) else 'FAIL',
        'changed': windows_manage_stig_doh_configured.changed | default(false),
        'check_mode': ansible_check_mode,
        'version_specific': true,
        'applies_to_versions': ['2022', '2025'],
        'os_version': windows_manage_stig_detected_version
      }] }}
  tags:
    - dns_over_https
    - compliance

# =============================================================================
# SMB OVER QUIC CONFIGURATION (2022+)
# =============================================================================

- name: STIG 2022+ | SMB over QUIC | Check if QUIC is required
  ansible.builtin.set_fact:
    windows_manage_stig_smb_quic_required: "{{ windows_manage_stig_smb_over_quic_required | default(false) }}"
  tags:
    - smb_over_quic
    - version_2022_plus

- name: STIG 2022+ | SMB over QUIC | Check current configuration
  when: windows_manage_stig_smb_quic_required
  ansible.windows.win_powershell:
    script: |
      try {
        # Check if SMB over QUIC is available
        $quicFeature = Get-WindowsFeature -Name 'FS-SMBBW' -ErrorAction SilentlyContinue
        if ($quicFeature) {
          @{
            'feature_installed' = $quicFeature.Installed
            'feature_available' = $true
          } | ConvertTo-Json
        } else {
          @{
            'feature_installed' = $false
            'feature_available' = $false
          } | ConvertTo-Json
        }
      } catch {
        @{
          'feature_installed' = $false
          'feature_available' = $false
          'error' = $_.Exception.Message
        } | ConvertTo-Json
      }
  register: windows_manage_stig_smb_quic_status
  check_mode: false
  changed_when: false

- name: STIG 2022+ | SMB over QUIC | Parse status
  when:
    - windows_manage_stig_smb_quic_required
    - windows_manage_stig_smb_quic_status is defined
    - windows_manage_stig_smb_quic_status.output is defined
  ansible.builtin.set_fact:
    windows_manage_stig_smb_quic_parsed: "{{ windows_manage_stig_smb_quic_status.output[0] | from_json }}"

- name: STIG 2022+ | SMB over QUIC | Record compliance result
  when:
    - windows_manage_stig_only_rules | length == 0 or 'V-SMB-QUIC' in windows_manage_stig_only_rules
  ansible.builtin.set_fact:
    windows_manage_stig_results: >-
      {{ windows_manage_stig_results | default([]) + [{
        'stig_id': 'V-SMB-QUIC',
        'title': 'SMB over QUIC must be configured when edge scenarios require encrypted SMB',
        'rule_section': 'Network Security',
        'severity': 'CAT II',
        'scored': false,
        'current_value': 'Required: ' + (windows_manage_stig_smb_quic_required | string) + ', Installed: ' + ((windows_manage_stig_smb_quic_parsed.feature_installed | default(false)) | string) if windows_manage_stig_smb_quic_required else 'Not Required',
        'expected_value': 'Configured when required for edge scenarios',
        'status': 'PASS' if (not windows_manage_stig_smb_quic_required or (windows_manage_stig_smb_quic_parsed.feature_installed | default(false))) else 'INFO',
        'changed': false,
        'check_mode': ansible_check_mode,
        'version_specific': true,
        'applies_to_versions': ['2022', '2025'],
        'os_version': windows_manage_stig_detected_version,
        'notes': 'SMB over QUIC is optional and typically used for edge/remote access scenarios'
      }] }}
  tags:
    - smb_over_quic
    - compliance

# =============================================================================
# TLS 1.3 VERIFICATION (2022+ default)
# =============================================================================

- name: STIG 2022+ | TLS 1.3 | Check current TLS configuration
  ansible.windows.win_powershell:
    script: |
      try {
        # Check TLS 1.3 registry keys
        $tls13Client = Get-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.3\Client' -Name 'Enabled' -ErrorAction SilentlyContinue
        $tls13Server = Get-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.3\Server' -Name 'Enabled' -ErrorAction SilentlyContinue

        # Check if .NET is configured for TLS 1.3
        $dotNetTls = Get-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\.NETFramework\v4.0.30319' -Name 'SchUseStrongCrypto' -ErrorAction SilentlyContinue

        @{
          'tls13_client_enabled' = if ($tls13Client) { $tls13Client.Enabled -eq 1 } else { $true }  # Default enabled in 2022+
          'tls13_server_enabled' = if ($tls13Server) { $tls13Server.Enabled -eq 1 } else { $true }  # Default enabled in 2022+
          'dotnet_strong_crypto' = if ($dotNetTls) { $dotNetTls.SchUseStrongCrypto -eq 1 } else { $false }
          'status' = 'configured'
        } | ConvertTo-Json
      } catch {
        @{
          'tls13_client_enabled' = $false
          'tls13_server_enabled' = $false
          'dotnet_strong_crypto' = $false
          'status' = 'error'
          'error' = $_.Exception.Message
        } | ConvertTo-Json
      }
  register: windows_manage_stig_tls13_status
  check_mode: false
  changed_when: false
  tags:
    - tls_configuration
    - version_2022_plus

- name: STIG 2022+ | TLS 1.3 | Parse TLS status
  when:
    - windows_manage_stig_tls13_status is defined
    - windows_manage_stig_tls13_status.output is defined
  ansible.builtin.set_fact:
    windows_manage_stig_tls13_parsed: "{{ windows_manage_stig_tls13_status.output[0] | from_json }}"

- name: STIG 2022+ | TLS 1.3 | Record compliance result
  when:
    - windows_manage_stig_only_rules | length == 0 or 'V-TLS-13' in windows_manage_stig_only_rules
  ansible.builtin.set_fact:
    windows_manage_stig_results: >-
      {{ windows_manage_stig_results | default([]) + [{
        'stig_id': 'V-TLS-13',
        'title': 'TLS 1.3 must be enabled as the default encryption protocol',
        'rule_section': 'Network Security',
        'severity': 'CAT II',
        'scored': true,
        'current_value': 'Client: ' + ((windows_manage_stig_tls13_parsed.tls13_client_enabled | default(false)) | string) + ', Server: ' + ((windows_manage_stig_tls13_parsed.tls13_server_enabled | default(false)) | string),
        'expected_value': 'TLS 1.3 enabled (default in 2022+)',
        'status': 'PASS' if (windows_manage_stig_tls13_parsed.tls13_client_enabled | default(false) and windows_manage_stig_tls13_parsed.tls13_server_enabled | default(false)) else 'FAIL',
        'changed': false,
        'check_mode': ansible_check_mode,
        'version_specific': true,
        'applies_to_versions': ['2022', '2025'],
        'os_version': windows_manage_stig_detected_version,
        'notes': 'TLS 1.3 is enabled by default in Windows Server 2022 and 2025'
      }] }}
  tags:
    - tls_configuration
    - compliance

# =============================================================================
# HOTPATCHING CONFIGURATION (2025 only)
# =============================================================================

- name: STIG 2025 | Hotpatching | Check Azure Arc connectivity
  when:
    - windows_manage_stig_hotpatching_enabled | default(true)
    - windows_manage_stig_only_rules | length == 0 or 'V-2025-HOTPATCH' in windows_manage_stig_only_rules
  ansible.windows.win_powershell:
    script: |
      try {
        # Check if Azure Arc agent is installed and connected
        $arcService = Get-Service -Name 'himds' -ErrorAction SilentlyContinue

        if ($arcService) {
          # Check Arc connection status
          $arcStatus = azcmagent show --output json 2>$null | ConvertFrom-Json -ErrorAction SilentlyContinue

          @{
            'arc_installed' = $true
            'arc_connected' = if ($arcStatus) { $arcStatus.status -eq 'Connected' } else { $false }
            'hotpatch_available' = $true
            'status' = 'configured'
          } | ConvertTo-Json
        } else {
          @{
            'arc_installed' = $false
            'arc_connected' = $false
            'hotpatch_available' = $false
            'status' = 'arc_not_installed'
          } | ConvertTo-Json
        }
      } catch {
        @{
          'arc_installed' = $false
          'arc_connected' = $false
          'hotpatch_available' = $false
          'status' = 'error'
          'error' = $_.Exception.Message
        } | ConvertTo-Json
      }
  register: windows_manage_stig_hotpatch_arc_status
  check_mode: false
  changed_when: false
  tags:
    - hotpatching
    - version_2025_only

- name: STIG 2025 | Hotpatching | Parse Arc status
  when:
    - windows_manage_stig_hotpatch_arc_status is defined
    - windows_manage_stig_hotpatch_arc_status.output is defined
  ansible.builtin.set_fact:
    windows_manage_stig_hotpatch_parsed: "{{ windows_manage_stig_hotpatch_arc_status.output[0] | from_json }}"

- name: STIG 2025 | Hotpatching | Check hotpatch configuration
  when:
    - windows_manage_stig_hotpatching_enabled | default(true)
    - windows_manage_stig_hotpatch_parsed.arc_connected | default(false)
    - windows_manage_stig_only_rules | length == 0 or 'V-2025-HOTPATCH' in windows_manage_stig_only_rules
  ansible.windows.win_reg_stat:
    path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Servicing
    name: RepairContent
  register: windows_manage_stig_hotpatch_config_status

- name: STIG 2025 | Hotpatching | Record compliance result (V-2025-HOTPATCH)
  when:
    - windows_manage_stig_only_rules | length == 0 or 'V-2025-HOTPATCH' in windows_manage_stig_only_rules
  ansible.builtin.set_fact:
    windows_manage_stig_results: >-
      {{ windows_manage_stig_results | default([]) + [{
        'stig_id': 'V-2025-HOTPATCH',
        'title': 'Hotpatching must be configured when Azure Arc is available',
        'rule_section': 'System Maintenance',
        'severity': 'CAT II',
        'scored': true,
        'current_value': 'Arc Connected: ' + ((windows_manage_stig_hotpatch_parsed.arc_connected | default(false)) | string) + ', Hotpatch Available: ' + ((windows_manage_stig_hotpatch_parsed.hotpatch_available | default(false)) | string),
        'expected_value': 'Azure Arc connected and hotpatch configured',
        'status': 'PASS' if (windows_manage_stig_hotpatch_parsed.arc_connected | default(false)) else 'INFO',
        'changed': false,
        'check_mode': ansible_check_mode,
        'version_specific': true,
        'applies_to_versions': ['2025'],
        'os_version': windows_manage_stig_detected_version,
        'notes': 'Hotpatching requires Azure Arc agent. Status: ' + (windows_manage_stig_hotpatch_parsed.status | default('unknown'))
      }] }}
  tags:
    - hotpatching
    - compliance

# =============================================================================
# NEXT-GEN CREDENTIAL GUARD (2025 only)
# =============================================================================

- name: STIG 2025 | Credential Guard | Check hardware support
  when:
    - windows_manage_stig_credential_guard_enabled | default(true)
    - windows_manage_stig_only_rules | length == 0 or 'V-278190' in windows_manage_stig_only_rules
  ansible.windows.win_powershell:
    script: |
      try {
        # Check for Credential Guard support
        $cgStatus = Get-ComputerInfo | Select-Object DeviceGuardSmartStatus, DeviceGuardRequiredSecurityProperties, DeviceGuardAvailableSecurityProperties

        # Check if Credential Guard is enabled
        $cgService = Get-CimInstance -ClassName Win32_DeviceGuard -Namespace root\Microsoft\Windows\DeviceGuard -ErrorAction SilentlyContinue

        @{
          'hardware_support' = if ($cgStatus.DeviceGuardAvailableSecurityProperties -contains 'CredentialGuard') { $true } else { $false }
          'credential_guard_running' = if ($cgService) { $cgService.SecurityServicesRunning -contains 1 } else { $false }
          'credential_guard_configured' = if ($cgService) { $cgService.SecurityServicesConfigured -contains 1 } else { $false }
          'status' = 'checked'
        } | ConvertTo-Json
      } catch {
        @{
          'hardware_support' = $false
          'credential_guard_running' = $false
          'credential_guard_configured' = $false
          'status' = 'error'
          'error' = $_.Exception.Message
        } | ConvertTo-Json
      }
  register: windows_manage_stig_credguard_status
  check_mode: false
  changed_when: false
  tags:
    - credential_guard
    - version_2025_only

- name: STIG 2025 | Credential Guard | Parse status
  when:
    - windows_manage_stig_credguard_status is defined
    - windows_manage_stig_credguard_status.output is defined
  ansible.builtin.set_fact:
    windows_manage_stig_credguard_parsed: "{{ windows_manage_stig_credguard_status.output[0] | from_json }}"

- name: STIG 2025 | Credential Guard | Enable if supported
  when:
    - windows_manage_stig_credential_guard_enabled | default(true)
    - windows_manage_stig_credguard_parsed.hardware_support | default(false)
    - not (windows_manage_stig_credguard_parsed.credential_guard_configured | default(false))
    - windows_manage_stig_only_rules | length == 0 or 'V-278190' in windows_manage_stig_only_rules
  ansible.windows.win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Control\DeviceGuard
    name: EnableVirtualizationBasedSecurity
    data: 1
    type: dword
  register: windows_manage_stig_credguard_enabled

- name: STIG 2025 | Credential Guard | Configure Credential Guard
  when:
    - windows_manage_stig_credential_guard_enabled | default(true)
    - windows_manage_stig_credguard_parsed.hardware_support | default(false)
    - windows_manage_stig_credguard_enabled.changed | default(false)
    - windows_manage_stig_only_rules | length == 0 or 'V-278190' in windows_manage_stig_only_rules
  ansible.windows.win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Control\DeviceGuard
    name: RequirePlatformSecurityFeatures
    data: 1  # Secure Boot only (1) or Secure Boot + DMA (3)
    type: dword
  register: windows_manage_stig_credguard_configured

- name: STIG 2025 | Credential Guard | Enable LsaCfgFlags
  when:
    - windows_manage_stig_credential_guard_enabled | default(true)
    - windows_manage_stig_credguard_parsed.hardware_support | default(false)
    - windows_manage_stig_only_rules | length == 0 or 'V-278190' in windows_manage_stig_only_rules
  ansible.windows.win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Control\Lsa
    name: LsaCfgFlags
    data: 1  # 1 = Enabled with UEFI lock
    type: dword
  register: windows_manage_stig_credguard_lsa_configured

- name: STIG 2025 | Credential Guard | Record compliance result (V-278190)
  when:
    - windows_manage_stig_only_rules | length == 0 or 'V-278190' in windows_manage_stig_only_rules
  ansible.builtin.set_fact:
    windows_manage_stig_results: >-
      {{ windows_manage_stig_results | default([]) + [{
        'stig_id': 'V-278190',
        'title': 'Next-Gen Credential Guard must be enabled on supported hardware',
        'rule_section': 'Access Control',
        'severity': 'CAT I',
        'scored': true,
        'current_value': 'HW Support: ' + ((windows_manage_stig_credguard_parsed.hardware_support | default(false)) | string) + ', Running: ' + ((windows_manage_stig_credguard_parsed.credential_guard_running | default(false)) | string) + ', Configured: ' + ((windows_manage_stig_credguard_parsed.credential_guard_configured | default(false)) | string),
        'expected_value': 'Credential Guard enabled on supported hardware',
        'status': 'PASS' if (windows_manage_stig_credguard_parsed.hardware_support | default(false) and (windows_manage_stig_credguard_parsed.credential_guard_configured | default(false) or windows_manage_stig_credguard_enabled.changed | default(false) or windows_manage_stig_credguard_configured.changed | default(false) or windows_manage_stig_credguard_lsa_configured.changed | default(false))) else ('INFO' if not (windows_manage_stig_credguard_parsed.hardware_support | default(false)) else 'FAIL'),
        'changed': (windows_manage_stig_credguard_enabled.changed | default(false)) or (windows_manage_stig_credguard_configured.changed | default(false)) or (windows_manage_stig_credguard_lsa_configured.changed | default(false)),
        'check_mode': ansible_check_mode,
        'version_specific': true,
        'applies_to_versions': ['2025'],
        'os_version': windows_manage_stig_detected_version,
        'notes': 'Requires hardware support (TPM 2.0, UEFI, Secure Boot). Reboot required after enabling.'
      }] }}
  tags:
    - credential_guard
    - compliance

# =============================================================================
# ACTIVE DIRECTORY 32K PAGE SUPPORT (2025 only)
# =============================================================================

- name: STIG 2025 | AD 32k Pages | Check if Domain Controller
  when:
    - windows_manage_stig_only_rules | length == 0 or 'V-2025-AD32K' in windows_manage_stig_only_rules
  ansible.windows.win_powershell:
    script: |
      try {
        # Check if this is a Domain Controller
        $isDC = (Get-WmiObject -Class Win32_ComputerSystem).DomainRole -ge 4

        if ($isDC) {
          # Check AD 32k page support
          $ad32kReg = Get-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\NTDS\Parameters' -Name 'Database page size' -ErrorAction SilentlyContinue

          @{
            'is_domain_controller' = $true
            'ad_32k_configured' = if ($ad32kReg) { $ad32kReg.'Database page size' -eq 32768 } else { $false }
            'current_page_size' = if ($ad32kReg) { $ad32kReg.'Database page size' } else { 8192 }
            'status' = 'configured'
          } | ConvertTo-Json
        } else {
          @{
            'is_domain_controller' = $false
            'ad_32k_configured' = $false
            'current_page_size' = 0
            'status' = 'not_dc'
          } | ConvertTo-Json
        }
      } catch {
        @{
          'is_domain_controller' = $false
          'ad_32k_configured' = $false
          'current_page_size' = 0
          'status' = 'error'
          'error' = $_.Exception.Message
        } | ConvertTo-Json
      }
  register: windows_manage_stig_ad_32k_status
  check_mode: false
  changed_when: false
  tags:
    - ad_32k_pages
    - version_2025_only

- name: STIG 2025 | AD 32k Pages | Parse status
  when:
    - windows_manage_stig_ad_32k_status is defined
    - windows_manage_stig_ad_32k_status.output is defined
  ansible.builtin.set_fact:
    windows_manage_stig_ad_32k_parsed: "{{ windows_manage_stig_ad_32k_status.output[0] | from_json }}"

- name: STIG 2025 | AD 32k Pages | Record compliance result (V-2025-AD32K)
  when:
    - windows_manage_stig_only_rules | length == 0 or 'V-2025-AD32K' in windows_manage_stig_only_rules
  ansible.builtin.set_fact:
    windows_manage_stig_results: >-
      {{ windows_manage_stig_results | default([]) + [{
        'stig_id': 'V-2025-AD32K',
        'title': 'Active Directory must use 32k page size when supported',
        'rule_section': 'Active Directory',
        'severity': 'CAT II',
        'scored': true,
        'current_value': 'Is DC: ' + ((windows_manage_stig_ad_32k_parsed.is_domain_controller | default(false)) | string) + ', Page Size: ' + ((windows_manage_stig_ad_32k_parsed.current_page_size | default(0)) | string),
        'expected_value': '32768 bytes (32k) for Domain Controllers',
        'status': 'PASS' if (not (windows_manage_stig_ad_32k_parsed.is_domain_controller | default(false)) or (windows_manage_stig_ad_32k_parsed.ad_32k_configured | default(false))) else 'INFO',
        'changed': false,
        'check_mode': ansible_check_mode,
        'version_specific': true,
        'applies_to_versions': ['2025'],
        'os_version': windows_manage_stig_detected_version,
        'notes': 'Only applies to Domain Controllers. 32k page size requires new AD forest installation or major upgrade.'
      }] }}
  tags:
    - ad_32k_pages
    - compliance

# =============================================================================
# SECTION SUMMARY
# =============================================================================

- name: STIG 2025 Features | Display configuration summary
  ansible.builtin.debug:
    msg:
      - ==========================================
      - Windows Server 2025 Advanced Features Summary
      - ==========================================
      - "Feature Configuration Status:"
      - "DNS-over-HTTPS: {{ 'Enabled' if (windows_manage_stig_doh_current_status.exists and windows_manage_stig_doh_current_status.value == (windows_manage_stig_dns_over_https_mode | default(2))) else 'Not Configured' }}"
      - "SMB over QUIC: {{ 'Required and checked' if windows_manage_stig_smb_quic_required else 'Not required (optional feature)' }}"
      - "TLS 1.3: {{ 'Enabled (default)' if (windows_manage_stig_tls13_parsed.tls13_client_enabled | default(false) and windows_manage_stig_tls13_parsed.tls13_server_enabled | default(false)) else 'Check required' }}"
      - "Hotpatching: {{ 'Arc Connected' if (windows_manage_stig_hotpatch_parsed.arc_connected | default(false)) else 'Arc Not Connected' }}"
      - "Next-Gen Credential Guard: {{ 'Enabled' if (windows_manage_stig_credguard_parsed.credential_guard_running | default(false)) else ('Hardware Not Supported' if not (windows_manage_stig_credguard_parsed.hardware_support | default(false)) else 'Not Configured') }}"
      - "AD 32k Pages: {{ 'Configured (32k)' if (windows_manage_stig_ad_32k_parsed.ad_32k_configured | default(false)) else ('Not DC' if not (windows_manage_stig_ad_32k_parsed.is_domain_controller | default(false)) else 'Standard 8k') }}"
      - ""
      - "VERSION-SPECIFIC CONTROLS: These features apply to Windows Server 2025"
      - "Current OS Version: {{ windows_manage_stig_detected_version }}"
      - ==========================================
      - "Execution Mode: {{ 'CHECK MODE (No Changes Applied)' if ansible_check_mode else 'APPLY MODE (Changes Applied)' }}"
      - ==========================================
  when: not ansible_check_mode or true
  tags:
    - version_2025_only
    - summary
