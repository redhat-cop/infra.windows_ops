---
# =============================================================================
# Windows Server 2022 Advanced Features - DISA STIG Controls
# DNS-over-HTTPS, SMB over QUIC, TLS 1.3
# =============================================================================

# =============================================================================
# DNS-OVER-HTTPS CONFIGURATION (2022+)
# =============================================================================

- name: STIG 2022+ | DNS-over-HTTPS | Check current configuration
  ansible.windows.win_reg_stat:
    path: HKLM:\SYSTEM\CurrentControlSet\Services\Dnscache\Parameters
    name: EnableDnsOverHttps
  register: windows_manage_stig_doh_current_status
  tags:
    - dns_over_https
    - version_2022_plus
    - stig

- name: STIG 2022+ | DNS-over-HTTPS | Enable DoH
  when:
    - windows_manage_stig_dns_over_https_enabled | default(true)
    - windows_manage_stig_only_rules | length == 0 or 'V-DNS-HTTPS' in windows_manage_stig_only_rules
    - not windows_manage_stig_doh_current_status.exists or windows_manage_stig_doh_current_status.value != windows_manage_stig_dns_over_https_mode | default(2)
  ansible.windows.win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Services\Dnscache\Parameters
    name: EnableDnsOverHttps
    data: "{{ windows_manage_stig_dns_over_https_mode | default(2) }}"
    type: dword
  register: windows_manage_stig_doh_configured

- name: STIG 2022+ | DNS-over-HTTPS | Record compliance result
  when:
    - windows_manage_stig_only_rules | length == 0 or 'V-DNS-HTTPS' in windows_manage_stig_only_rules
  ansible.builtin.set_fact:
    windows_manage_stig_results: >-
      {{ windows_manage_stig_results | default([]) + [{
        'stig_id': 'V-DNS-HTTPS',
        'title': 'DNS-over-HTTPS must be enabled to protect DNS queries',
        'rule_section': 'Network Security',
        'severity': 'CAT II',
        'scored': true,
        'current_value': (windows_manage_stig_doh_current_status.value | default(0) | string) if windows_manage_stig_doh_current_status.exists else 'Not Configured',
        'expected_value': (windows_manage_stig_dns_over_https_mode | default(2) | string),
        'status': 'PASS' if (windows_manage_stig_doh_current_status.exists and windows_manage_stig_doh_current_status.value == (windows_manage_stig_dns_over_https_mode | default(2))) else ('REMEDIATED' if (windows_manage_stig_doh_configured.changed | default(false)) else 'FAIL'),
        'changed': windows_manage_stig_doh_configured.changed | default(false),
        'check_mode': ansible_check_mode,
        'version_specific': true,
        'applies_to_versions': ['2022', '2025'],
        'os_version': windows_manage_stig_detected_version
      }] }}
  tags:
    - dns_over_https
    - compliance

# =============================================================================
# SMB OVER QUIC CONFIGURATION (2022+)
# =============================================================================

- name: STIG 2022+ | SMB over QUIC | Check if QUIC is required
  ansible.builtin.set_fact:
    windows_manage_stig_smb_quic_required: "{{ windows_manage_stig_smb_over_quic_required | default(false) }}"
  tags:
    - smb_over_quic
    - version_2022_plus

- name: STIG 2022+ | SMB over QUIC | Check current configuration
  when: windows_manage_stig_smb_quic_required
  ansible.windows.win_powershell:
    script: |
      try {
        # Check if SMB over QUIC is available
        $quicFeature = Get-WindowsFeature -Name 'FS-SMBBW' -ErrorAction SilentlyContinue
        if ($quicFeature) {
          @{
            'feature_installed' = $quicFeature.Installed
            'feature_available' = $true
          } | ConvertTo-Json
        } else {
          @{
            'feature_installed' = $false
            'feature_available' = $false
          } | ConvertTo-Json
        }
      } catch {
        @{
          'feature_installed' = $false
          'feature_available' = $false
          'error' = $_.Exception.Message
        } | ConvertTo-Json
      }
  register: windows_manage_stig_smb_quic_status
  changed_when: false

- name: STIG 2022+ | SMB over QUIC | Parse status
  when:
    - windows_manage_stig_smb_quic_required
    - windows_manage_stig_smb_quic_status is defined
    - windows_manage_stig_smb_quic_status.output is defined
  ansible.builtin.set_fact:
    windows_manage_stig_smb_quic_parsed: "{{ windows_manage_stig_smb_quic_status.output[0] | from_json }}"

- name: STIG 2022+ | SMB over QUIC | Record compliance result
  when:
    - windows_manage_stig_only_rules | length == 0 or 'V-SMB-QUIC' in windows_manage_stig_only_rules
  ansible.builtin.set_fact:
    windows_manage_stig_results: >-
      {{ windows_manage_stig_results | default([]) + [{
        'stig_id': 'V-SMB-QUIC',
        'title': 'SMB over QUIC must be configured when edge scenarios require encrypted SMB',
        'rule_section': 'Network Security',
        'severity': 'CAT II',
        'scored': false,
        'current_value': 'Required: ' + (windows_manage_stig_smb_quic_required | string) + ', Installed: ' + ((windows_manage_stig_smb_quic_parsed.feature_installed | default(false)) | string) if windows_manage_stig_smb_quic_required else 'Not Required',
        'expected_value': 'Configured when required for edge scenarios',
        'status': 'PASS' if (not windows_manage_stig_smb_quic_required or (windows_manage_stig_smb_quic_parsed.feature_installed | default(false))) else 'INFO',
        'changed': false,
        'check_mode': ansible_check_mode,
        'version_specific': true,
        'applies_to_versions': ['2022', '2025'],
        'os_version': windows_manage_stig_detected_version,
        'notes': 'SMB over QUIC is optional and typically used for edge/remote access scenarios'
      }] }}
  tags:
    - smb_over_quic
    - compliance

# =============================================================================
# TLS 1.3 VERIFICATION (2022+ default)
# =============================================================================

- name: STIG 2022+ | TLS 1.3 | Check current TLS configuration
  ansible.windows.win_powershell:
    script: |
      try {
        # Check TLS 1.3 registry keys
        $tls13Client = Get-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.3\Client' -Name 'Enabled' -ErrorAction SilentlyContinue
        $tls13Server = Get-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.3\Server' -Name 'Enabled' -ErrorAction SilentlyContinue

        # Check if .NET is configured for TLS 1.3
        $dotNetTls = Get-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\.NETFramework\v4.0.30319' -Name 'SchUseStrongCrypto' -ErrorAction SilentlyContinue

        @{
          'tls13_client_enabled' = if ($tls13Client) { $tls13Client.Enabled -eq 1 } else { $true }  # Default enabled in 2022+
          'tls13_server_enabled' = if ($tls13Server) { $tls13Server.Enabled -eq 1 } else { $true }  # Default enabled in 2022+
          'dotnet_strong_crypto' = if ($dotNetTls) { $dotNetTls.SchUseStrongCrypto -eq 1 } else { $false }
          'status' = 'configured'
        } | ConvertTo-Json
      } catch {
        @{
          'tls13_client_enabled' = $false
          'tls13_server_enabled' = $false
          'dotnet_strong_crypto' = $false
          'status' = 'error'
          'error' = $_.Exception.Message
        } | ConvertTo-Json
      }
  register: windows_manage_stig_tls13_status
  changed_when: false
  tags:
    - tls_configuration
    - version_2022_plus

- name: STIG 2022+ | TLS 1.3 | Parse TLS status
  when:
    - windows_manage_stig_tls13_status is defined
    - windows_manage_stig_tls13_status.output is defined
  ansible.builtin.set_fact:
    windows_manage_stig_tls13_parsed: "{{ windows_manage_stig_tls13_status.output[0] | from_json }}"

- name: STIG 2022+ | TLS 1.3 | Record compliance result
  when:
    - windows_manage_stig_only_rules | length == 0 or 'V-TLS-13' in windows_manage_stig_only_rules
  ansible.builtin.set_fact:
    windows_manage_stig_results: >-
      {{ windows_manage_stig_results | default([]) + [{
        'stig_id': 'V-TLS-13',
        'title': 'TLS 1.3 must be enabled as the default encryption protocol',
        'rule_section': 'Network Security',
        'severity': 'CAT II',
        'scored': true,
        'current_value': 'Client: ' + ((windows_manage_stig_tls13_parsed.tls13_client_enabled | default(false)) | string) + ', Server: ' + ((windows_manage_stig_tls13_parsed.tls13_server_enabled | default(false)) | string),
        'expected_value': 'TLS 1.3 enabled (default in 2022+)',
        'status': 'PASS' if (windows_manage_stig_tls13_parsed.tls13_client_enabled | default(false) and windows_manage_stig_tls13_parsed.tls13_server_enabled | default(false)) else 'FAIL',
        'changed': false,
        'check_mode': ansible_check_mode,
        'version_specific': true,
        'applies_to_versions': ['2022', '2025'],
        'os_version': windows_manage_stig_detected_version,
        'notes': 'TLS 1.3 is enabled by default in Windows Server 2022 and 2025'
      }] }}
  tags:
    - tls_configuration
    - compliance

# =============================================================================
# SECTION SUMMARY
# =============================================================================

- name: STIG 2022+ Features | Display configuration summary
  ansible.builtin.debug:
    msg:
      - ==========================================
      - Windows Server 2022+ Features Summary (STIG)
      - ==========================================
      - "Feature Configuration Status:"
      - "DNS-over-HTTPS: {{ 'Enabled' if (windows_manage_stig_doh_current_status.exists and windows_manage_stig_doh_current_status.value == (windows_manage_stig_dns_over_https_mode | default(2))) else 'Not Configured' }}"
      - "SMB over QUIC: {{ 'Required and checked' if windows_manage_stig_smb_quic_required else 'Not required (optional feature)' }}"
      - "TLS 1.3: {{ 'Enabled (default)' if (windows_manage_stig_tls13_parsed.tls13_client_enabled | default(false) and windows_manage_stig_tls13_parsed.tls13_server_enabled | default(false)) else 'Check required' }}"
      - ""
      - "VERSION-SPECIFIC CONTROLS: These features apply to Windows Server 2022 and 2025"
      - "Current OS Version: {{ windows_manage_stig_detected_version }}"
      - ==========================================
      - "Execution Mode: {{ 'CHECK MODE (No Changes Applied)' if ansible_check_mode else 'APPLY MODE (Changes Applied)' }}"
      - ==========================================
  when: not ansible_check_mode or true
  tags:
    - version_2022_plus
    - summary
