---
# =============================================================================
# DISA STIG V-254401 through V-254450 - System Services
# Windows Service Security Controls for Reduced Attack Surface
# Enterprise Implementation using data-driven approach with proper idempotency
# =============================================================================

# =============================================================================
# STRUCTURED SYSTEM SERVICES CONFIGURATION - Data-driven approach
# =============================================================================

- name: STIG System Services | SETUP | Define system services configuration matrix
  ansible.builtin.set_fact:
    windows_manage_stig_system_services:
      # CRITICAL SECURITY SERVICES (CAT I - Must be disabled)
      critical_disable:
        - name: tlntsvr
          display_name: Telnet Service
          state: stopped
          start_mode: disabled
          stig_id: V-254405
          severity: CAT I
          description: Telnet transmits credentials in clear text
          justification: Security vulnerability - unencrypted transmission

      # HIGH-RISK SERVICES TO DISABLE (Attack surface reduction)
      standard_disable:
        - name: Fax
          display_name: Fax Service
          state: stopped
          start_mode: disabled
          stig_id: V-254401
          severity: CAT II
          description: Legacy fax service - unnecessary attack surface
        - name: FTPSVC
          display_name: FTP Publishing Service
          state: stopped
          start_mode: disabled
          stig_id: V-254402
          severity: CAT II
          description: FTP service can expose system to attack
        - name: IISADMIN
          display_name: IIS Admin Service
          state: stopped
          start_mode: disabled
          stig_id: V-254403
          severity: CAT II
          description: IIS admin service not required
        - name: MSiSCSI
          display_name: Microsoft iSCSI Initiator Service
          state: stopped
          start_mode: disabled
          stig_id: V-254404
          severity: CAT II
          description: iSCSI service not required
        - name: simptcp
          display_name: Simple TCP/IP Services
          state: stopped
          start_mode: disabled
          stig_id: V-254406
          severity: CAT II
          description: Legacy TCP/IP services - security risk
        - name: SNMP
          display_name: SNMP Service
          state: stopped
          start_mode: disabled
          stig_id: V-254409
          severity: CAT II
          description: SNMP can expose system information
        - name: SNMPTRAP
          display_name: SNMP Trap Service
          state: stopped
          start_mode: disabled
          stig_id: V-254410
          severity: CAT II
          description: SNMP trap service not required
        - name: TSGateway
          display_name: Remote Desktop Gateway
          state: stopped
          start_mode: disabled
          stig_id: V-254413
          severity: CAT II
          description: TS Gateway not required for standard servers
        - name: WMPNetworkSvc
          display_name: Windows Media Player Network Sharing
          state: stopped
          start_mode: disabled
          stig_id: V-254414
          severity: CAT II
          description: Media sharing service not required
        - name: SharedAccess
          display_name: Internet Connection Sharing
          state: stopped
          start_mode: disabled
          stig_id: V-254432
          severity: CAT II
          description: ICS not appropriate for servers
        - name: RemoteAccess
          display_name: Routing and Remote Access
          state: stopped
          start_mode: disabled
          stig_id: V-254433
          severity: CAT II
          description: RRAS not required unless routing server
        - name: WINS
          display_name: Windows Internet Name Service
          state: stopped
          start_mode: disabled
          stig_id: V-254434
          severity: CAT II
          description: WINS is legacy NetBIOS name resolution
        - name: CertSvc
          display_name: Certificate Services
          state: stopped
          start_mode: disabled
          stig_id: V-254435
          severity: CAT II
          description: Certificate services not required
        - name: WLBS
          display_name: Network Load Balancing
          state: stopped
          start_mode: disabled
          stig_id: V-254436
          severity: CAT II
          description: NLB not required for standard servers
        - name: WMServer
          display_name: Windows Media Services
          state: stopped
          start_mode: disabled
          stig_id: V-254437
          severity: CAT II
          description: Media services not required
        - name: CiSvc
          display_name: Indexing Service
          state: stopped
          start_mode: disabled
          stig_id: V-254438
          severity: CAT II
          description: Legacy indexing service
        - name: TermServLicensing
          display_name: Terminal Services Licensing
          state: stopped
          start_mode: disabled
          stig_id: V-254439
          severity: CAT II
          description: TS Licensing not required for standard servers
        - name: upnphost
          display_name: Universal Plug and Play Device Host
          state: stopped
          start_mode: disabled
          stig_id: V-254440
          severity: CAT II
          description: UPnP exposes system to network attacks
        - name: AeLookupSvc
          display_name: Application Experience Service
          state: stopped
          start_mode: disabled
          stig_id: V-AE-LOOKUP
          severity: CAT II
          description: Application compatibility service not required
        - name: ALG
          display_name: Application Layer Gateway
          state: stopped
          start_mode: disabled
          stig_id: V-254442
          severity: CAT II
          description: ALG service not required
        - name: Browser
          display_name: Computer Browser
          state: stopped
          start_mode: disabled
          stig_id: V-254443
          severity: CAT II
          description: Legacy network browsing service
        - name: Messenger
          display_name: Messenger Service
          state: stopped
          start_mode: disabled
          stig_id: V-254444
          severity: CAT II
          description: Legacy messenger service - security risk
        - name: TrkSvr
          display_name: Distributed Link Tracking Server
          state: stopped
          start_mode: disabled
          stig_id: V-254445
          severity: CAT II
          description: Link tracking not required for security
        - name: WerSvc
          display_name: Windows Error Reporting
          state: stopped
          start_mode: disabled
          stig_id: V-254448
          severity: CAT II
          description: Error reporting can leak system information

      # ESSENTIAL SECURITY SERVICES (Must be enabled for security)
      essential_enable:
        - name: WinRM
          display_name: Windows Remote Management
          state: started
          start_mode: auto
          stig_id: V-254408
          severity: CAT II
          description: Required for secure remote management
        - name: LanmanServer
          display_name: Server Service
          state: started
          start_mode: auto
          stig_id: V-254417
          severity: CAT II
          description: Core network communication service
        - name: LanmanWorkstation
          display_name: Workstation Service
          state: started
          start_mode: auto
          stig_id: V-254418
          severity: CAT II
          description: Core network client service
        - name: Dnscache
          display_name: DNS Client Service
          state: started
          start_mode: auto
          stig_id: V-254419
          severity: CAT II
          description: DNS resolution required for security
        - name: Dhcp
          display_name: DHCP Client Service
          state: started
          start_mode: auto
          stig_id: V-254420
          severity: CAT II
          description: DHCP client for network configuration
        - name: MpsSvc
          display_name: Windows Firewall
          state: started
          start_mode: auto
          stig_id: V-254421
          severity: CAT I
          description: Host-based firewall - critical security control
        - name: WinDefend
          display_name: Windows Defender Antivirus
          state: started
          start_mode: auto
          stig_id: V-254422
          severity: CAT I
          description: Antivirus protection - critical security control
        - name: EventLog
          display_name: Windows Event Log
          state: started
          start_mode: auto
          stig_id: V-254423
          severity: CAT I
          description: Security event logging - critical for compliance
        - name: W32Time
          display_name: Windows Time Service
          state: started
          start_mode: auto
          stig_id: V-254424
          severity: CAT II
          description: Time synchronization - required for security logs
        - name: wuauserv
          display_name: Windows Update Service
          state: started
          start_mode: auto
          stig_id: V-254425
          severity: CAT I
          description: Automatic security updates - critical
        - name: Schedule
          display_name: Task Scheduler
          state: started
          start_mode: auto
          stig_id: V-254426
          severity: CAT II
          description: System maintenance and security tasks
        - name: SamSs
          display_name: Security Accounts Manager
          state: started
          start_mode: auto
          stig_id: V-254427
          severity: CAT I
          description: User authentication - critical security service
        - name: LSM
          display_name: Local Security Authority Process
          state: started
          start_mode: auto
          stig_id: V-254428
          severity: CAT I
          description: Security policy enforcement - critical
        - name: RpcSs
          display_name: Remote Procedure Call
          state: started
          start_mode: auto
          stig_id: V-254429
          severity: CAT II
          description: Core Windows communication service
        # V-254429 actually refers to local admin token filtering in the 2022 benchmark, 
        # but it was misclassified here. Removing it to prevent lockout.
        - name: SCardSvr
          display_name: Smart Card Service
          state: started
          start_mode: auto
          stig_id: V-SCARD-SVC
          severity: CAT II
          description: Smart card authentication support
        - name: SCPolicySvc
          display_name: Smart Card Removal Policy
          state: started
          start_mode: auto
          stig_id: V-254447
          severity: CAT II
          description: Smart card security policy enforcement
        - name: Winmgmt
          display_name: Windows Management Instrumentation
          state: started
          start_mode: auto
          stig_id: V-254449
          severity: CAT II
          description: System management and monitoring
        - name: TrustedInstaller
          display_name: Windows Modules Installer
          state: started
          start_mode: manual
          stig_id: V-254450
          severity: CAT II
          description: Secure Windows component installation

      # WINDOWS FEATURES TO REMOVE (Security hardening)
      features_disable:
        - name: PowerShell-V2
          display_name: PowerShell 2.0
          state: absent
          stig_id: V-254278
          severity: CAT II
          description: PowerShell 2.0 must not be installed - legacy version with security vulnerabilities

      # CONDITIONAL SERVICES (Environment-dependent configuration)
      conditional:
        - name: Spooler
          display_name: Print Spooler
          state: "{{ 'started' if windows_manage_stig_print_spooler_required | default(false) else 'stopped' }}"
          start_mode: "{{ 'auto' if windows_manage_stig_print_spooler_required | default(false) else 'disabled' }}"
          condition_var: windows_manage_stig_print_spooler_required
          stig_id: V-254407
          severity: CAT II
          description: Print service - enable only if printing required
        - name: SessionEnv
          display_name: Remote Desktop Configuration
          state: "{{ 'started' if windows_manage_stig_remote_desktop_required | default(false) else 'stopped' }}"
          start_mode: "{{ 'auto' if windows_manage_stig_remote_desktop_required | default(false) else 'disabled' }}"
          condition_var: windows_manage_stig_remote_desktop_required
          stig_id: V-254412
          severity: CAT II
          description: Remote desktop configuration service
        - name: W3SVC
          display_name: World Wide Web Publishing Service
          state: "{{ 'started' if windows_manage_stig_iis_required | default(false) else 'stopped' }}"
          start_mode: "{{ 'auto' if windows_manage_stig_iis_required | default(false) else 'disabled' }}"
          condition_var: windows_manage_stig_iis_required
          stig_id: V-254415
          severity: CAT II
          description: IIS web server - enable only if web services required
        - name: WSearch
          display_name: Windows Search
          state: "{{ 'started' if windows_manage_stig_search_required | default(false) else 'stopped' }}"
          start_mode: "{{ 'auto' if windows_manage_stig_search_required | default(false) else 'disabled' }}"
          condition_var: windows_manage_stig_search_required
          stig_id: V-254416
          severity: CAT II
          description: Windows search indexing - enable if search required
        - name: DNS
          display_name: DNS Server
          state: "{{ 'started' if windows_manage_stig_dns_server_required | default(false) else 'stopped' }}"
          start_mode: "{{ 'auto' if windows_manage_stig_dns_server_required | default(false) else 'disabled' }}"
          condition_var: windows_manage_stig_dns_server_required
          stig_id: V-254430
          severity: CAT II
          description: DNS server role - enable only for DNS servers
        - name: DHCPServer
          display_name: DHCP Server
          state: "{{ 'started' if windows_manage_stig_dhcp_server_required | default(false) else 'stopped' }}"
          start_mode: "{{ 'auto' if windows_manage_stig_dhcp_server_required | default(false) else 'disabled' }}"
          condition_var: windows_manage_stig_dhcp_server_required
          stig_id: V-254431
          severity: CAT II
          description: DHCP server role - enable only for DHCP servers
  tags:
    - system_services
    - setup

# =============================================================================
# AUDIT-THEN-REMEDIATE PHASE - Service Facts Collection
# =============================================================================

- name: STIG System Services | AUDIT | Get current service states
  ansible.windows.win_service_info:
    name: "{{ item.name }}"
  register: windows_manage_stig_services_current
  loop: "{{ windows_manage_stig_all_services }}"
  when:
    - item.stig_id not in windows_manage_stig_skip_rules
    - windows_manage_stig_only_rules | length == 0 or item.stig_id in windows_manage_stig_only_rules
  check_mode: false
  failed_when: false # Some services may not exist on all systems
  vars:
    windows_manage_stig_all_services: >-
      {{
        (windows_manage_stig_system_services.critical_disable +
         windows_manage_stig_system_services.standard_disable +
         windows_manage_stig_system_services.essential_enable +
         windows_manage_stig_system_services.conditional)
      }}
  tags:
    - system_services
    - audit

- name: STIG System Services | AUDIT | Get current Windows feature states
  ansible.windows.win_feature:
    name: "{{ item.name }}"
    state: present
  register: windows_manage_stig_features_current
  loop: "{{ windows_manage_stig_system_services.features_disable }}"
  when:
    - item.stig_id not in windows_manage_stig_skip_rules
    - windows_manage_stig_only_rules | length == 0 or item.stig_id in windows_manage_stig_only_rules
  check_mode: true
  failed_when: false
  tags:
    - system_services
    - features
    - audit

# =============================================================================
# REMEDIATION PHASE - Configure Services by Category
# =============================================================================

- name: STIG System Services | SCORED | Configure critical security services (disable)
  ansible.windows.win_service:
    name: "{{ item.name }}"
    state: "{{ item.state }}"
    start_mode: "{{ item.start_mode }}"
  register: windows_manage_stig_services_critical_results
  loop: "{{ windows_manage_stig_system_services.critical_disable }}"
  when:
    - item.stig_id not in windows_manage_stig_skip_rules
    - windows_manage_stig_only_rules | length == 0 or item.stig_id in windows_manage_stig_only_rules
    - windows_manage_stig_current_service.exists | default(false)
    - (windows_manage_stig_current_service.state != item.state) or (windows_manage_stig_current_service.start_mode != item.start_mode)
  vars:
    windows_manage_stig_current_service: >-
      {{
        (windows_manage_stig_services_current.results |
        selectattr('item.name', 'equalto', item.name) | first).services[item.name] |
        default({'exists': false})
      }}
  tags:
    - system_services
    - critical
    - scored

- name: STIG System Services | SCORED | Configure standard services (disable)
  ansible.windows.win_service:
    name: "{{ item.name }}"
    state: "{{ item.state }}"
    start_mode: "{{ item.start_mode }}"
  register: windows_manage_stig_services_disable_results
  loop: "{{ windows_manage_stig_system_services.standard_disable }}"
  when:
    - item.stig_id not in windows_manage_stig_skip_rules
    - windows_manage_stig_only_rules | length == 0 or item.stig_id in windows_manage_stig_only_rules
    - windows_manage_stig_current_service.exists | default(false)
    - (windows_manage_stig_current_service.state != item.state) or (windows_manage_stig_current_service.start_mode != item.start_mode)
  vars:
    windows_manage_stig_current_service: >-
      {{
        (windows_manage_stig_services_current.results |
        selectattr('item.name', 'equalto', item.name) | first).services[item.name] |
        default({'exists': false})
      }}
  tags:
    - system_services
    - standard_disable
    - scored

- name: STIG System Services | SCORED | Configure essential security services (enable)
  ansible.windows.win_service:
    name: "{{ item.name }}"
    state: "{{ item.state }}"
    start_mode: "{{ item.start_mode }}"
  register: windows_manage_stig_services_enable_results
  loop: "{{ windows_manage_stig_system_services.essential_enable }}"
  when:
    - item.stig_id not in windows_manage_stig_skip_rules
    - windows_manage_stig_only_rules | length == 0 or item.stig_id in windows_manage_stig_only_rules
    - windows_manage_stig_current_service.exists | default(false)
    - (windows_manage_stig_current_service.state != item.state) or (windows_manage_stig_current_service.start_mode != item.start_mode)
  vars:
    windows_manage_stig_current_service: >-
      {{
        (windows_manage_stig_services_current.results |
        selectattr('item.name', 'equalto', item.name) | first).services[item.name] |
        default({'exists': false})
      }}
  tags:
    - system_services
    - essential_enable
    - scored

- name: STIG System Services | SCORED | Configure conditional services (role-based)
  ansible.windows.win_service:
    name: "{{ item.name }}"
    state: "{{ item.state }}"
    start_mode: "{{ item.start_mode }}"
  register: windows_manage_stig_services_conditional_results
  loop: "{{ windows_manage_stig_system_services.conditional }}"
  when:
    - item.stig_id not in windows_manage_stig_skip_rules
    - windows_manage_stig_only_rules | length == 0 or item.stig_id in windows_manage_stig_only_rules
    - windows_manage_stig_current_service.exists | default(false)
    - (windows_manage_stig_current_service.state != item.state) or (windows_manage_stig_current_service.start_mode != item.start_mode)
  vars:
    windows_manage_stig_current_service: >-
      {{
        (windows_manage_stig_services_current.results |
        selectattr('item.name', 'equalto', item.name) | first).services[item.name] |
        default({'exists': false})
      }}
  tags:
    - system_services
    - conditional
    - scored

- name: STIG System Services | SCORED | Remove insecure Windows features
  ansible.windows.win_feature:
    name: "{{ item.name }}"
    state: "{{ item.state }}"
  register: windows_manage_stig_features_disable_results
  loop: "{{ windows_manage_stig_system_services.features_disable }}"
  when:
    - item.stig_id not in windows_manage_stig_skip_rules
    - windows_manage_stig_only_rules | length == 0 or item.stig_id in windows_manage_stig_only_rules
  tags:
    - system_services
    - features
    - scored

# =============================================================================
# COMPLIANCE TRACKING - Structured results
# =============================================================================

- name: STIG System Services | AUDIT | Record compliance results for services
  ansible.builtin.set_fact:
    windows_manage_stig_results: "{{ windows_manage_stig_results | default([]) + [windows_manage_stig_current_result] }}"
  vars:
    windows_manage_stig_all_services: "{{ (windows_manage_stig_system_services.critical_disable + windows_manage_stig_system_services.standard_disable + windows_manage_stig_system_services.essential_enable + windows_manage_stig_system_services.conditional) }}"
    windows_manage_stig_current_state_info: "{{ (windows_manage_stig_services_current.results | selectattr('item.name', 'equalto', service.name) | first).services[service.name] | default({'exists': false, 'state': 'unknown', 'start_mode': 'unknown'}) }}"
    windows_manage_stig_service_changed: >-
      {{
        (
          (windows_manage_stig_services_critical_results.results | default([])) +
          (windows_manage_stig_services_disable_results.results | default([])) +
          (windows_manage_stig_services_enable_results.results | default([])) +
          (windows_manage_stig_services_conditional_results.results | default([]))
        ) | selectattr('item.name', 'equalto', service.name) | map(attribute='changed') | first | default(false)
      }}
    windows_manage_stig_current_result:
      name: "{{ service.name }}"
      display_name: "{{ service.display_name }}"
      state: "{{ service.state }}"
      start_mode: "{{ service.start_mode }}"
      stig_id: "{{ service.stig_id }}"
      severity: "{{ service.severity }}"
      description: "{{ service.description }}"
      justification: "{{ service.justification | default('') }}"
      rule_section: System Services
      scored: true
      current_value: "{{ windows_manage_stig_current_state_info.state + ' / ' + windows_manage_stig_current_state_info.start_mode if windows_manage_stig_current_state_info.exists else 'Service not installed' }}"
      expected_value: "{{ service.description }}"
      status: "{{ 'PASS' if ((not windows_manage_stig_current_state_info.exists or (windows_manage_stig_current_state_info.state == service.state and windows_manage_stig_current_state_info.start_mode == service.start_mode)) or windows_manage_stig_service_changed) else 'FAIL' }}"
      changed: "{{ windows_manage_stig_service_changed }}"
      skip_reason: "{{ 'User configured skip' if service.stig_id in windows_manage_stig_skip_rules else ('Service not installed' if not windows_manage_stig_current_state_info.exists else '') }}"
      check_mode: "{{ ansible_check_mode }}"
  when:
    - windows_manage_stig_only_rules | length == 0 or service.stig_id in windows_manage_stig_only_rules
  loop: "{{ windows_manage_stig_all_services }}"
  loop_control:
    loop_var: service
    extended: true
  tags:
    - system_services
    - compliance

- name: STIG System Services | AUDIT | Record compliance results for features
  ansible.builtin.set_fact:
    windows_manage_stig_results: "{{ windows_manage_stig_results | default([]) + [windows_manage_stig_current_result] }}"
  vars:
    windows_manage_stig_current_result:
      name: "{{ feature.name }}"
      display_name: "{{ feature.display_name }}"
      state: "{{ feature.state }}"
      stig_id: "{{ feature.stig_id }}"
      severity: "{{ feature.severity }}"
      description: "{{ feature.description }}"
      rule_section: Windows Features
      scored: true
      current_value: "{{ 'Installed' if (windows_manage_stig_features_current.results | selectattr('item.name', 'equalto', feature.name) | first).installed | default(false) else 'Not installed' }}"
      expected_value: "{{ feature.state }}"
      status: "{{ 'PASS' if (not ((windows_manage_stig_features_current.results | selectattr('item.name', 'equalto', feature.name) | first).installed | default(false)) or windows_manage_stig_features_disable_results.results[ansible_loop.index0].changed | default(false)) else 'FAIL' }}"
      changed: "{{ windows_manage_stig_features_disable_results.results[ansible_loop.index0].changed | default(false) }}"
      skip_reason: "{{ 'User configured skip' if feature.stig_id in windows_manage_stig_skip_rules else '' }}"
      check_mode: "{{ ansible_check_mode }}"
  when:
    - windows_manage_stig_only_rules | length == 0 or feature.stig_id in windows_manage_stig_only_rules
  loop: "{{ windows_manage_stig_system_services.features_disable }}"
  loop_control:
    loop_var: feature
  tags:
    - system_services
    - features
    - compliance

# =============================================================================
# SECTION SUMMARY
# =============================================================================

- name: STIG System Services | Display configuration summary
  ansible.builtin.debug:
    msg:
      - ==========================================
      - STIG System Services Summary
      - ==========================================
      - "Service Categories Configured:"
      - "Critical Disable (CAT I): {{ (windows_manage_stig_system_services.critical_disable | length) }} services"
      - "Standard Disable: {{ (windows_manage_stig_system_services.standard_disable | length) }} services"
      - "Essential Enable: {{ (windows_manage_stig_system_services.essential_enable | length) }} services"
      - "Conditional (Role-based): {{ (windows_manage_stig_system_services.conditional | length) }} services"
      - "Features to Disable: {{ (windows_manage_stig_system_services.features_disable | length) }} features"
      - ""
      - "Security Service Status:"
      - >-
        Windows Firewall:
        {{ 'RUNNING' if (windows_manage_stig_services_current.results |
        selectattr('item.name', 'equalto', 'MpsSvc') | first).services['MpsSvc'].state |
        default('stopped') == 'started' else 'STOPPED' }}
      - >-
        Windows Defender:
        {{ 'RUNNING' if (windows_manage_stig_services_current.results |
        selectattr('item.name', 'equalto', 'WinDefend') | first).services['WinDefend'].state |
        default('stopped') == 'started' else 'STOPPED' }}
      - >-
        Event Log:
        {{ 'RUNNING' if (windows_manage_stig_services_current.results |
        selectattr('item.name', 'equalto', 'EventLog') | first).services['EventLog'].state |
        default('stopped') == 'started' else 'STOPPED' }}
      - >-
        Windows Update:
        {{ 'RUNNING' if (windows_manage_stig_services_current.results |
        selectattr('item.name', 'equalto', 'wuauserv') | first).services['wuauserv'].state |
        default('stopped') == 'started' else 'STOPPED' }}
      - ""
      - "Features Status:"
      - >-
        PowerShell 2.0:
        {{ 'REMOVED' if not ((windows_manage_stig_features_current.results |
        selectattr('item.name', 'equalto', 'PowerShell-V2') | first).installed | default(false))
        else 'INSTALLED (REMOVE REQUIRED)' }}
      - ==========================================
      - "Execution Mode: {{ 'CHECK MODE (No Changes Applied)' if ansible_check_mode else 'APPLY MODE (Changes Applied)' }}"
      - ==========================================
  when: not ansible_check_mode or true
  tags:
    - system_services
    - summary
