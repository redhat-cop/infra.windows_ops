---
# CIS Microsoft Windows Server 2022 Benchmark v1.0.0
# Section 17.9: Event Log Configuration
# Enterprise Implementation - Critical Event Log Controls (6 controls)

# =============================================================================
# CIS 17.9.1 - Application Event Log Configuration
# =============================================================================

# CIS 17.9.1 - Application: Maximum log size
- name: CIS 17.9.1 | AUDIT | Get current Application log maximum size
  ansible.windows.win_reg_stat:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\EventLog\Application
    name: MaxSize
  register: windows_manage_cis_17_9_1_current
  tags:
    - cis_17.9.1
    - event_log
    - level_1
    - audit

- name: CIS 17.9.1 | SCORED | Configure Application log maximum size
  ansible.windows.win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\EventLog\Application
    name: MaxSize
    data: "{{ windows_manage_cis_application_log_maximum_size }}"
    type: dword
  register: windows_manage_cis_17_9_1_result
  when:
    - "'17.9.1' not in windows_manage_cis_skip_rules"
    - windows_manage_cis_17_9_1_current.value | default(0) != windows_manage_cis_application_log_maximum_size
  tags:
    - cis_17.9.1
    - event_log
    - level_1
    - scored

- name: CIS 17.9.1 | AUDIT | Record compliance result
  ansible.builtin.set_fact:
    windows_manage_cis_results: "{{ windows_manage_cis_results + [{'rule_id': '17.9.1', 'rule_title': 'Windows Logs: Application: Maximum log size', 'rule_section':
      'Event Log Configuration', 'severity': 'Medium', 'scored': true, 'level': 'Level 1', 'expected_value': (windows_manage_cis_application_log_maximum_size | string)
      + ' KB', 'current_value': ((windows_manage_cis_17_9_1_current.value | default('Not Configured') | string) + (' KB' if windows_manage_cis_17_9_1_current.value
      is defined else '')), 'status': ('PASS' if (windows_manage_cis_17_9_1_current.value | default(0) == windows_manage_cis_application_log_maximum_size) else 'FAIL'),
      'changed': windows_manage_cis_17_9_1_result.changed | default(false), 'skip_reason': 'User configured skip' if '17.9.1' in windows_manage_cis_skip_rules else
      '', 'check_mode': ansible_check_mode}] }}"
  tags:
    - cis_17.9.1
    - event_log

# CIS 17.9.2 - Application: Retention method for log file
- name: CIS 17.9.2 | AUDIT | Get current Application log retention method
  ansible.windows.win_reg_stat:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\EventLog\Application
    name: Retention
  register: windows_manage_cis_17_9_2_current
  tags:
    - cis_17.9.2
    - event_log
    - level_1
    - audit

- name: CIS 17.9.2 | SCORED | Configure Application log retention method
  ansible.windows.win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\EventLog\Application
    name: Retention
    data: "{{ '0' if windows_manage_cis_application_log_retention_method == 'OverwriteAsNeeded' else '1' }}"
    type: string
  register: windows_manage_cis_17_9_2_result
  when:
    - "'17.9.2' not in windows_manage_cis_skip_rules"
    - windows_manage_cis_17_9_2_current.value | default('0') != ('0' if windows_manage_cis_application_log_retention_method == 'OverwriteAsNeeded' else '1')
  tags:
    - cis_17.9.2
    - event_log
    - level_1
    - scored

- name: CIS 17.9.2 | AUDIT | Record compliance result
  ansible.builtin.set_fact:
    windows_manage_cis_results: "{{ windows_manage_cis_results + [{'rule_id': '17.9.2', 'rule_title': 'Windows Logs: Application: Retention method for log file',
      'rule_section': 'Event Log Configuration', 'severity': 'Medium', 'scored': true, 'level': 'Level 1', 'expected_value': windows_manage_cis_application_log_retention_method,
      'current_value': ('OverwriteAsNeeded' if windows_manage_cis_17_9_2_current.value | default('0') == '0' else 'DoNotOverwrite'), 'status': 'PASS' if (windows_manage_cis_17_9_2_current.value
      | default('0') == ('0' if windows_manage_cis_application_log_retention_method == 'OverwriteAsNeeded' else '1')) else 'FAIL', 'changed': windows_manage_cis_17_9_2_result.changed
      | default(false), 'skip_reason': 'User configured skip' if '17.9.2' in windows_manage_cis_skip_rules else '', 'check_mode': ansible_check_mode}] }}"
  tags:
    - cis_17.9.2
    - event_log

# =============================================================================
# CIS 17.9.3 - Security Event Log Configuration
# =============================================================================

# CIS 17.9.3 - Security: Maximum log size
- name: CIS 17.9.3 | AUDIT | Get current Security log maximum size
  ansible.windows.win_reg_stat:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\EventLog\Security
    name: MaxSize
  register: windows_manage_cis_17_9_3_current
  tags:
    - cis_17.9.3
    - event_log
    - level_1
    - audit

- name: CIS 17.9.3 | SCORED | Configure Security log maximum size
  ansible.windows.win_regedit:
    path: HKLM:\SOFTWARE\Policies\Microsoft\Windows\EventLog\Security
    name: MaxSize
    data: "{{ windows_manage_cis_security_log_maximum_size }}"
    type: dword
  register: windows_manage_cis_17_9_3_result
  when:
    - "'17.9.3' not in windows_manage_cis_skip_rules"
    - windows_manage_cis_17_9_3_current.value | default(0) != windows_manage_cis_security_log_maximum_size
  tags:
    - cis_17.9.3
    - event_log
    - level_1
    - scored

- name: CIS 17.9.3 | AUDIT | Record compliance result
  ansible.builtin.set_fact:
    windows_manage_cis_results: >-
      {{ windows_manage_cis_results + [{
        'rule_id': '17.9.3',
        'rule_title': 'Windows Logs: Security: Maximum log size',
        'rule_section': 'Event Log Configuration',
        'severity': 'High',
        'scored': true,
        'level': 'Level 1',
        'expected_value': (windows_manage_cis_security_log_maximum_size | string) + ' KB',
        'current_value': (windows_manage_cis_17_9_3_current.value | default('Not Configured') | string) + (' KB' if windows_manage_cis_17_9_3_current.value is defined
      else ''),
        'status': 'PASS' if (windows_manage_cis_17_9_3_current.value | default(0) == windows_manage_cis_security_log_maximum_size) else 'FAIL',
        'changed': windows_manage_cis_17_9_3_result.changed | default(false),
        'skip_reason': 'User configured skip' if '17.9.3' in windows_manage_cis_skip_rules else '',
        'check_mode': ansible_check_mode
      }] }}
  tags:
    - cis_17.9.3
    - event_log

# =============================================================================
# SECTION SUMMARY - Event Log Configuration
# =============================================================================

- name: CIS Section 17.9 | Display Event Log configuration summary
  ansible.builtin.debug:
    msg:
      - ==========================================
      - "CIS Section 17.9: Event Log Configuration Summary"
      - ==========================================
      - ENTERPRISE IMPLEMENTATION - 3 critical event log controls
      - ""
      - "Application Event Log:"
      - "17.9.1 Maximum Size: {{ 'COMPLIANT' if windows_manage_cis_17_9_1_current.value | default(0) == windows_manage_cis_application_log_maximum_size else 'NON-COMPLIANT'
        }} ({{ windows_manage_cis_17_9_1_current.value | default('Not Set') }} KB)"
      - "17.9.2 Retention Method: {{ 'COMPLIANT' if windows_manage_cis_17_9_2_current.value | default('0') == ('0' if windows_manage_cis_application_log_retention_method
        == 'OverwriteAsNeeded' else '1') else 'NON-COMPLIANT' }}"
      - ""
      - "Security Event Log:"
      - "17.9.3 Maximum Size: {{ 'COMPLIANT' if windows_manage_cis_17_9_3_current.value | default(0) == windows_manage_cis_security_log_maximum_size else 'NON-COMPLIANT'
        }} ({{ windows_manage_cis_17_9_3_current.value | default('Not Set') }} KB)"
      - ""
      - "Note: Proper event log sizing ensures adequate audit trail retention"
      - Security log should be sized appropriately for audit policy configuration
      - ==========================================
      - "Execution Mode: {{ 'CHECK MODE (No Changes Applied)' if ansible_check_mode else 'APPLY MODE (Changes Applied)' }}"
      - ==========================================
  when: not ansible_check_mode or true
  tags:
    - event_log
    - section_17
    - summary
