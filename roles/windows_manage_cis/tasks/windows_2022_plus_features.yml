---
# =============================================================================
# Windows Server 2022+ Features - CIS Benchmark Controls
# Features available in Windows Server 2022 and 2025
# DNS-over-HTTPS, SMB over QUIC, TLS 1.3
# =============================================================================

# =============================================================================
# DNS-OVER-HTTPS CONFIGURATION (2022+)
# =============================================================================

- name: CIS 2022+ | DNS-over-HTTPS | Check current configuration
  ansible.windows.win_reg_stat:
    path: HKLM:\SYSTEM\CurrentControlSet\Services\Dnscache\Parameters
    name: EnableDnsOverHttps
  register: windows_manage_cis_doh_current_status
  tags:
    - dns_over_https
    - version_2022_plus
    - cis

- name: CIS 2022+ | DNS-over-HTTPS | Enable DoH
  when:
    - windows_manage_cis_dns_over_https_enabled | default(true)
    - not windows_manage_cis_doh_current_status.exists or windows_manage_cis_doh_current_status.value != (windows_manage_cis_dns_over_https_mode | default(2))
  ansible.windows.win_regedit:
    path: HKLM:\SYSTEM\CurrentControlSet\Services\Dnscache\Parameters
    name: EnableDnsOverHttps
    data: "{{ windows_manage_cis_dns_over_https_mode | default(2) }}"
    type: dword
  register: windows_manage_cis_doh_configured

- name: CIS 2022+ | DNS-over-HTTPS | Record compliance result
  ansible.builtin.set_fact:
    windows_manage_cis_results: >-
      {{ windows_manage_cis_results | default([]) + [{
        'rule_id': '18.10.DNS.1',
        'title': 'Ensure DNS-over-HTTPS is enabled',
        'rule_section': 'Network Security',
        'level': 'Level 2',
        'scored': true,
        'current_value': (windows_manage_cis_doh_current_status.value | default(0) | string) if windows_manage_cis_doh_current_status.exists else 'Not Configured',
        'expected_value': (windows_manage_cis_dns_over_https_mode | default(2) | string),
        'status': 'PASS' if (windows_manage_cis_doh_current_status.exists and windows_manage_cis_doh_current_status.value == (windows_manage_cis_dns_over_https_mode | default(2))) else ('REMEDIATED' if (windows_manage_cis_doh_configured.changed | default(false)) else 'FAIL'),
        'changed': windows_manage_cis_doh_configured.changed | default(false),
        'check_mode': ansible_check_mode,
        'version_specific': true,
        'applies_to_versions': ['2022', '2025'],
        'os_version': windows_manage_cis_detected_version
      }] }}
  tags:
    - dns_over_https
    - compliance

# =============================================================================
# TLS 1.3 VERIFICATION (2022+ default)
# =============================================================================

- name: CIS 2022+ | TLS 1.3 | Check current TLS configuration
  ansible.windows.win_powershell:
    script: |
      try {
        # Check TLS 1.3 registry keys
        $tls13Client = Get-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.3\Client' -Name 'Enabled' -ErrorAction SilentlyContinue
        $tls13Server = Get-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.3\Server' -Name 'Enabled' -ErrorAction SilentlyContinue

        @{
          'tls13_client_enabled' = if ($tls13Client) { $tls13Client.Enabled -eq 1 } else { $true }  # Default enabled in 2022+
          'tls13_server_enabled' = if ($tls13Server) { $tls13Server.Enabled -eq 1 } else { $true }  # Default enabled in 2022+
          'status' = 'configured'
        } | ConvertTo-Json
      } catch {
        @{
          'tls13_client_enabled' = $false
          'tls13_server_enabled' = $false
          'status' = 'error'
          'error' = $_.Exception.Message
        } | ConvertTo-Json
      }
  register: windows_manage_cis_tls13_status
  changed_when: false
  tags:
    - tls_configuration
    - version_2022_plus

- name: CIS 2022+ | TLS 1.3 | Parse TLS status
  when:
    - windows_manage_cis_tls13_status is defined
    - windows_manage_cis_tls13_status.output is defined
  ansible.builtin.set_fact:
    windows_manage_cis_tls13_parsed: "{{ windows_manage_cis_tls13_status.output[0] | from_json }}"

- name: CIS 2022+ | TLS 1.3 | Record compliance result
  ansible.builtin.set_fact:
    windows_manage_cis_results: >-
      {{ windows_manage_cis_results | default([]) + [{
        'rule_id': '18.10.TLS.1',
        'title': 'Ensure TLS 1.3 is enabled',
        'rule_section': 'Network Security',
        'level': 'Level 1',
        'scored': true,
        'current_value': 'Client: ' + ((windows_manage_cis_tls13_parsed.tls13_client_enabled | default(false)) | string) + ', Server: ' + ((windows_manage_cis_tls13_parsed.tls13_server_enabled | default(false)) | string),
        'expected_value': 'TLS 1.3 enabled (default in 2022+)',
        'status': 'PASS' if (windows_manage_cis_tls13_parsed.tls13_client_enabled | default(false) and windows_manage_cis_tls13_parsed.tls13_server_enabled | default(false)) else 'FAIL',
        'changed': false,
        'check_mode': ansible_check_mode,
        'version_specific': true,
        'applies_to_versions': ['2022', '2025'],
        'os_version': windows_manage_cis_detected_version,
        'notes': 'TLS 1.3 is enabled by default in Windows Server 2022 and 2025'
      }] }}
  tags:
    - tls_configuration
    - compliance

# =============================================================================
# SECTION SUMMARY
# =============================================================================

- name: CIS 2022+ Features | Display configuration summary
  ansible.builtin.debug:
    msg:
      - ==========================================
      - Windows Server 2022+ Features Summary (CIS)
      - ==========================================
      - "Feature Configuration Status:"
      - "DNS-over-HTTPS: {{ 'Enabled' if (windows_manage_cis_doh_current_status.exists and windows_manage_cis_doh_current_status.value == (windows_manage_cis_dns_over_https_mode | default(2))) else 'Not Configured' }}"
      - "TLS 1.3: {{ 'Enabled (default)' if (windows_manage_cis_tls13_parsed.tls13_client_enabled | default(false) and windows_manage_cis_tls13_parsed.tls13_server_enabled | default(false)) else 'Check required' }}"
      - ""
      - "VERSION-SPECIFIC CONTROLS: These features apply to Windows Server 2022 and 2025 only"
      - "Current OS Version: {{ windows_manage_cis_detected_version }}"
      - ==========================================
      - "Execution Mode: {{ 'CHECK MODE (No Changes Applied)' if ansible_check_mode else 'APPLY MODE (Changes Applied)' }}"
      - ==========================================
  when: not ansible_check_mode or true
  tags:
    - version_2022_plus
    - summary
