---
# CIS Microsoft Windows Server 2022 Benchmark v1.0.0
# Section 5: System Services
# HARDENED Implementation with Structured JSON and Native Modules

# =============================================================================
# STRUCTURED SYSTEM SERVICES CONFIGURATION - Data-driven approach
# =============================================================================

- name: CIS System Services | SETUP | Define system services configuration matrix
  ansible.builtin.set_fact:
    windows_manage_cis_system_services:
      # Critical Security Services (Must be disabled)
      critical_disable:
        - rule_id: "5.2"
          title: Remote Registry
          service: RemoteRegistry
          state: stopped
          start_mode: disabled
          description: Remote registry access poses security risk
          severity: High
          level: Level 1
        - rule_id: "5.4"
          title: Simple TCP/IP Services
          service: simptcp
          state: stopped
          start_mode: disabled
          description: Legacy TCP/IP services are security vulnerabilities
          severity: Medium
          level: Level 1
        - rule_id: "5.5"
          title: Telnet
          service: TlntSvr
          state: stopped
          start_mode: disabled
          description: Telnet transmits data in clear text
          severity: High
          level: Level 1
        - rule_id: "5.8"
          title: Xbox Live Auth Manager
          service: XblAuthManager
          state: stopped
          start_mode: disabled
          description: Gaming service not required on servers
          severity: Low
          level: Level 1

      # Conditional Services (Environment-dependent)
      conditional:
        - rule_id: "5.1"
          title: Print Spooler
          service: Spooler
          state: "{{ 'started' if windows_manage_cis_allow_print_spooler | default(false) else 'stopped' }}"
          start_mode: "{{ 'auto' if windows_manage_cis_allow_print_spooler | default(false) else 'disabled' }}"
          condition_var: windows_manage_cis_allow_print_spooler
          description: Print service - disable unless printing required
          severity: Medium
          level: Level 1
        - rule_id: "5.3"
          title: Server (File Sharing)
          service: LanmanServer
          state: "{{ 'started' if windows_manage_cis_allow_file_sharing | default(true) else 'stopped' }}"
          start_mode: "{{ 'auto' if windows_manage_cis_allow_file_sharing | default(true) else 'disabled' }}"
          condition_var: windows_manage_cis_allow_file_sharing
          description: File sharing service - required for most servers
          severity: Medium
          level: Level 1
        - rule_id: "5.6"
          title: Windows Remote Management (WinRM)
          service: WinRM
          state: "{{ 'started' if windows_manage_cis_allow_winrm | default(true) else 'stopped' }}"
          start_mode: "{{ 'auto' if windows_manage_cis_allow_winrm | default(true) else 'disabled' }}"
          condition_var: windows_manage_cis_allow_winrm
          description: Remote management service - usually required
          severity: Medium
          level: Level 1
        - rule_id: "5.7"
          title: World Wide Web Publishing Service (IIS)
          service: W3SVC
          state: "{{ 'started' if windows_manage_cis_allow_iis | default(false) else 'stopped' }}"
          start_mode: "{{ 'auto' if windows_manage_cis_allow_iis | default(false) else 'disabled' }}"
          condition_var: windows_manage_cis_allow_iis
          description: Web server service - enable only if web server role
          severity: Medium
          level: Level 1
  tags:
    - system_services
    - setup

# =============================================================================
# HARDENED AUDIT PHASE - Structured JSON for Service States
# =============================================================================

- name: CIS System Services | AUDIT | Get current service states (structured)
  ansible.windows.win_powershell:
    script: |
      $ErrorActionPreference = 'Stop'
      try {
        # Define services to check
        $serviceNames = @('RemoteRegistry', 'simptcp', 'TlntSvr', 'XblAuthManager', 'Spooler', 'LanmanServer', 'WinRM', 'W3SVC')

        $serviceStates = @{}

        foreach ($serviceName in $serviceNames) {
          try {
            $service = Get-Service -Name $serviceName -ErrorAction Stop
            $serviceStates[$serviceName] = @{
              status = $service.Status.ToString()
              start_type = $service.StartType.ToString()
              exists = $true
            }
          }
          catch {
            $serviceStates[$serviceName] = @{
              status = 'Not Found'
              start_type = 'Not Found'
              exists = $false
            }
          }
        }

        $Ansible.Result = @{
          services = $serviceStates
          source = "Get-Service"
          timestamp = Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ"
          status = "success"
        }
      }
      catch {
        $Ansible.Failed = $true
        $Ansible.Result = @{
          error = $_.Exception.Message
          line_number = $_.InvocationInfo.ScriptLineNumber
          status = "failed"
        }
      }
  register: windows_manage_cis_services_current_all
  check_mode: false
  tags:
    - system_services
    - audit
    - hardened

# =============================================================================
# MODERNIZED REMEDIATION PHASE - Native ansible.windows Modules
# =============================================================================

- name: CIS System Services | SCORED | Configure critical security services (disable)
  ansible.windows.win_service:
    name: "{{ item.service }}"
    state: "{{ item.state }}"
    start_mode: "{{ item.start_mode }}"
    force_dependent_services: true
  register: windows_manage_cis_services_critical_results
  loop: "{{ windows_manage_cis_system_services.critical_disable }}"
  when:
    - item.rule_id not in windows_manage_cis_skip_rules
    - current_service.exists | default(false)
    - (current_service.status != item.state | title) or (current_service.start_type | lower != item.start_mode)
  vars:
    current_service: >-
      {{
        windows_manage_cis_services_current_all.result.services[item.service] |
        default({'exists': false, 'status': 'Unknown', 'start_type': 'Unknown'})
      }}
  tags:
    - system_services
    - critical_disable
    - scored

- name: CIS System Services | SCORED | Configure conditional services (role-based)
  ansible.windows.win_service:
    name: "{{ item.service }}"
    state: "{{ item.state }}"
    start_mode: "{{ item.start_mode }}"
  register: windows_manage_cis_services_conditional_results
  loop: "{{ windows_manage_cis_system_services.conditional }}"
  when:
    - item.rule_id not in windows_manage_cis_skip_rules
    - current_service.exists | default(false)
    - (current_service.status != item.state | title) or (current_service.start_type | lower != item.start_mode)
  vars:
    current_service: >-
      {{
        windows_manage_cis_services_current_all.result.services[item.service] |
        default({'exists': false, 'status': 'Unknown', 'start_type': 'Unknown'})
      }}
  tags:
    - system_services
    - conditional
    - scored

# =============================================================================
# HARDENED COMPLIANCE TRACKING - Structured Results
# =============================================================================

- name: CIS System Services | AUDIT | Record compliance results (structured)
  ansible.builtin.set_fact:
    windows_manage_cis_results: "{{ windows_manage_cis_results | default([]) + (all_services | map('combine', {'rule_section': 'System Services', 'scored': true,
      'current_value': current_service.status + ' / ' + current_service.start_type if current_service.exists else 'Service not installed', 'expected_value': item.state
      | title + ' / ' + item.start_mode | title, 'status': ('PASS' if (not current_service.exists or (current_service.status == (item.state | title) and current_service.start_type
      | lower == item.start_mode)) else 'FAIL'), 'changed': task_changed, 'skip_reason': ('User configured skip' if item.rule_id in windows_manage_cis_skip_rules
      else ('Service not installed' if not current_service.exists else '')), 'audit_timestamp': windows_manage_cis_services_current_all.result.timestamp | default(''),
      'check_mode': ansible_check_mode}) | list) }}"
  vars:
    all_services: "{{ windows_manage_cis_system_services.critical_disable + windows_manage_cis_system_services.conditional }}"
    current_service: "{{ windows_manage_cis_services_current_all.result.services[item.service] | default({'exists': false, 'status': 'Unknown', 'start_type': 'Unknown'})
      }}"
    task_changed: false # Will be updated by actual task results
    item: "{{ service }}"
  loop: "{{ all_services }}"
  loop_control:
    loop_var: service
  tags:
    - system_services
    - compliance
    - hardened

# =============================================================================
# SECTION SUMMARY - Hardened Implementation
# =============================================================================

- name: CIS System Services | Display hardened implementation summary
  ansible.builtin.debug:
    msg:
      - ==========================================
      - CIS System Services Summary (HARDENED)
      - ==========================================
      - "Service Configuration Status:"
      - "Critical Security Services: {{ (windows_manage_cis_system_services.critical_disable | length) }} configured"
      - "Conditional Services: {{ (windows_manage_cis_system_services.conditional | length) }} configured"
      - ""
      - "RELIABILITY: Eliminated fragile shell command parsing with structured JSON"
      - "IDEMPOTENCY: True declarative state management with native modules"
      - "MAINTAINABILITY: Future-proof against Windows command output changes"
      - "PERFORMANCE: Consolidated audit queries and data-driven configuration"
      - ==========================================
      - "Service Audit Source: {{ windows_manage_cis_services_current_all.result.source | default('N/A') }}"
      - "Audit Timestamp: {{ windows_manage_cis_services_current_all.result.timestamp | default('N/A') }}"
      - "Execution Mode: {{ 'CHECK MODE (No Changes Applied)' if ansible_check_mode else 'APPLY MODE (Changes Applied)' }}"
      - ==========================================
  when: not ansible_check_mode or true
  tags:
    - system_services
    - hardened
    - summary
