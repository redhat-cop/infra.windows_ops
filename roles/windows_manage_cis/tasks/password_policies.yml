---
# CIS Microsoft Windows Server 2022 Benchmark v1.0.0
# Section 1.1: Password Policy Settings
# Implementation with Structured JSON and Native Modules
# This demonstrates the recommended approach for all CIS role tasks

# =============================================================================
# STRUCTURED PASSWORD POLICY CONFIGURATION - Data-driven approach
# =============================================================================

- name: CIS Password Policies | SETUP | Define password policy configuration matrix
  ansible.builtin.set_fact:
    windows_manage_cis_password_policies:
      - rule_id: 1.1.1
        title: Enforce password history
        section: System Access
        key: PasswordHistorySize
        value: "{{ windows_manage_cis_password_history_size }}"
        level: Level 1
        severity: Medium
        description: Number of unique passwords before reuse
      - rule_id: 1.1.2
        title: Maximum password age
        section: System Access
        key: MaximumPasswordAge
        value: "{{ windows_manage_cis_maximum_password_age }}"
        level: Level 1
        severity: Medium
        description: Maximum days before password expires
      - rule_id: 1.1.3
        title: Minimum password age
        section: System Access
        key: MinimumPasswordAge
        value: "{{ windows_manage_cis_minimum_password_age }}"
        level: Level 1
        severity: Medium
        description: Minimum days before password can be changed
      - rule_id: 1.1.4
        title: Minimum password length
        section: System Access
        key: MinimumPasswordLength
        value: "{{ windows_manage_cis_minimum_password_length }}"
        level: Level 1
        severity: Medium
        description: Minimum number of characters in password
      - rule_id: 1.1.5
        title: Password must meet complexity requirements
        section: System Access
        key: PasswordComplexity
        value: "{{ windows_manage_cis_password_complexity_enabled | int }}"
        level: Level 1
        severity: Medium
        description: Enforce complex password requirements
      - rule_id: 1.1.6
        title: Store passwords using reversible encryption
        section: System Access
        key: ClearTextPassword
        value: "{{ windows_manage_cis_password_reversible_encryption | int }}"
        level: Level 1
        severity: High
        description: Disable reversible password encryption
  tags:
    - password_policies
    - setup

# =============================================================================
# AUDIT PHASE - Structured JSON Return Data
# =============================================================================

- name: CIS Password Policies | AUDIT | Get all current password policy settings (structured)
  ansible.windows.win_powershell:
    script: |
      $ErrorActionPreference = 'Stop'
      try {
        # Export security policy to temporary file
        $tempFile = [System.IO.Path]::GetTempFileName()
        secedit /export /cfg $tempFile | Out-Null

        if ($LASTEXITCODE -eq 0) {
          $content = Get-Content $tempFile

          # Parse password policy settings into structured data
          $passwordPolicies = @{}

          foreach ($line in $content) {
            if ($line -match '^(PasswordHistorySize|MaximumPasswordAge|MinimumPasswordAge|MinimumPasswordLength|PasswordComplexity|ClearTextPassword)\s*=\s*(.*)$') {
              $key = $matches[1]
              $value = $matches[2].Trim()
              $passwordPolicies[$key] = $value
            }
          }

          # Return structured JSON data
          $result = @{
            policies = $passwordPolicies
            source = "secedit"
            timestamp = Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ"
            status = "success"
          }

          # Cleanup
          Remove-Item $tempFile -Force -ErrorAction SilentlyContinue

          # Return as structured object (not text)
          $Ansible.Result = $result
        } else {
          throw "secedit export failed with exit code $LASTEXITCODE"
        }
      }
      catch {
        $Ansible.Failed = $true
        $Ansible.Result = @{
          error = $_.Exception.Message
          line_number = $_.InvocationInfo.ScriptLineNumber
          status = "failed"
        }
      }
  register: windows_manage_cis_password_current_all
  check_mode: false
  tags:
    - password_policies
    - audit
    - hardened

# =============================================================================
# MODERNIZED REMEDIATION PHASE - Native ansible.windows Modules
# =============================================================================

- name: CIS Password Policies | SCORED | Configure password policies (modernized)
  community.windows.win_security_policy:
    section: "{{ item.section }}"
    key: "{{ item.key }}"
    value: "{{ item.value }}"
  register: windows_manage_cis_password_results
  loop: "{{ windows_manage_cis_password_policies }}"
  when:
    - item.rule_id not in windows_manage_cis_skip_rules
    - windows_manage_cis_password_current_all.result.policies[item.key] | default('') | string != item.value | string
  loop_control:
    extended: true
  tags:
    - password_policies
    - scored
    - modernized

# =============================================================================
# COMPLIANCE TRACKING - Structured Results
# =============================================================================

- name: CIS Password Policies | AUDIT | Record compliance results (structured)
  ansible.builtin.set_fact:
    windows_manage_cis_results: >-
      {{ windows_manage_cis_results | default([]) + (windows_manage_cis_password_policies | map('combine', {
        'rule_section': 'Password Policy',
        'scored': true,
        'current_value': windows_manage_cis_password_current_all.result.policies[item.key] | default('Not Configured'),
        'expected_value': item.value,
        'status': 'PASS' if (windows_manage_cis_password_current_all.result.policies[item.key] | default('') | string == item.value | string) else 'FAIL',
        'changed': (windows_manage_cis_password_results.results | selectattr('item.rule_id', 'equalto', item.rule_id) | list | first).changed | default(false),
        'skip_reason': 'User configured skip' if item.rule_id in windows_manage_cis_skip_rules else '',
        'audit_timestamp': windows_manage_cis_password_current_all.result.timestamp | default(''),
        'check_mode': ansible_check_mode
      }) | list) }}
  vars:
    item: "{{ password_policy }}"
  loop: "{{ windows_manage_cis_password_policies }}"
  loop_control:
    loop_var: password_policy
  tags:
    - password_policies
    - compliance
    - hardened

# =============================================================================
# SECTION SUMMARY - Hardened Implementation
# =============================================================================

- name: CIS Password Policies | Display hardened implementation summary
  ansible.builtin.debug:
    msg:
      - ==========================================
      - CIS Password Policies Summary
      - ==========================================
      - "Password Policy Status:"
      - "Total Policies: {{ windows_manage_cis_password_policies | length }} configured"
      - "Compliant Policies: {{ (windows_manage_cis_password_policies | selectattr('key', 'defined') | map('extract', windows_manage_cis_password_current_all.result.policies,
        'key') | select('defined') | list | length) }} checked"
      - ""
      - ==========================================
      - "Audit Source: {{ windows_manage_cis_password_current_all.result.source | default('N/A') }}"
      - "Audit Timestamp: {{ windows_manage_cis_password_current_all.result.timestamp | default('N/A') }}"
      - "Execution Mode: {{ 'CHECK MODE (No Changes Applied)' if ansible_check_mode else 'APPLY MODE (Changes Applied)' }}"
      - ==========================================
  when: not ansible_check_mode or true
  tags:
    - password_policies
    - hardened
    - summary
