---
- name: Test CIS role application and validation
  block:
    - name: Create test output directory
      ansible.windows.win_file:
        path: "{{ test_cis_output_dir }}"
        state: directory

    - name: Apply CIS Level 1 hardening in check mode
      ansible.builtin.include_role:
        name: infra.windows_ops.windows_manage_cis
      vars:
        windows_manage_cis_level: level_1
        windows_manage_cis_check_mode: true
        windows_manage_cis_report_path: "{{ test_cis_output_dir }}"

    - name: Find CIS compliance report files
      ansible.windows.win_find:
        paths: "{{ test_cis_output_dir }}"
        patterns: "*_cis_compliance_*.json"
      register: _cis_report_files

    - name: Assert CIS compliance report was created
      ansible.builtin.assert:
        that:
          - _cis_report_files.files | length > 0
          - _cis_report_files.files[0].size > 0
        fail_msg: "CIS compliance report not found in {{ test_cis_output_dir }}"

    - name: Display test completion message
      ansible.builtin.debug:
        msg: "CIS baseline test completed successfully"

  rescue:
    - name: Cleanup on test failure
      ansible.windows.win_file:
        path: "{{ test_cis_output_dir }}"
        state: absent
      failed_when: false

    - name: Fail the test
      ansible.builtin.fail:
        msg: "CIS role integration test failed"

  always:
    - name: Cleanup test directory
      ansible.windows.win_file:
        path: "{{ test_cis_output_dir }}"
        state: absent
      failed_when: false
