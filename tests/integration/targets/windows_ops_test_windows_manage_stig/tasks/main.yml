---
# =============================================================================
# Windows STIG Role Integration Tests
# =============================================================================

- name: Execute STIG integration tests
  block:
    - name: Initialize test history
      ansible.builtin.set_fact:
        stig_test_history: []

    - name: Run version detection test
      ansible.builtin.include_tasks: version_detection.yml

    - name: Run full STIG execution test
      ansible.builtin.include_tasks: full_execution.yml

    - name: Run Advanced Features verification
      ansible.builtin.include_tasks: advanced_features_verification.yml

    - name: Run STIG rule filtering test
      ansible.builtin.include_tasks: rule_filtering.yml

    - name: Display final consolidated summary
      ansible.builtin.include_tasks: final_summary.yml

  always:
    - name: Final cleanup - Remove version detection test directory
      ansible.windows.win_file:
        path: "{{ test_stig_output_dir }}_version"
        state: absent
      failed_when: false

    - name: Final cleanup - Remove full execution test directory
      ansible.windows.win_file:
        path: "{{ test_stig_output_dir }}"
        state: absent
      failed_when: false

    - name: Final cleanup - Remove filtering test directory
      ansible.windows.win_file:
        path: "{{ test_stig_filtered_output_dir }}"
        state: absent
      failed_when: false
