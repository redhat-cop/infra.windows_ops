---
# =============================================================================
# STIG Rule Filtering Test (ACA-4989)
# Tests windows_manage_stig_only_rules filtering functionality
# =============================================================================
- name: Test windows_manage_stig_only_rules filtering functionality
  block:
    - name: Create filtered test output directory
      ansible.windows.win_file:
        path: "{{ test_stig_filtered_output_dir }}"
        state: directory

    - name: Apply STIG with only_rules filter (3 specific rules from different categories)
      ansible.builtin.include_role:
        name: infra.windows_ops.windows_manage_stig
      vars:
        windows_manage_stig_only_rules:
          - V-254238  # Account Policies: Enforce password history
          - V-254247  # Audit Policies: Audit account logon events
          - V-254451  # User Rights: Act as part of the operating system
        windows_manage_stig_report_path: "{{ test_stig_filtered_output_dir }}\\filtered_report.json"
        windows_manage_stig_generate_report: true

    - name: Read filtered compliance report
      ansible.builtin.slurp:
        src: "{{ test_stig_filtered_output_dir }}\\filtered_report.json"
      register: _filtered_report_content

    - name: Parse filtered compliance report
      ansible.builtin.set_fact:
        _filtered_report: "{{ _filtered_report_content.content | b64decode | from_json }}"

    - name: Debug - Display all rule IDs in filtered report
      ansible.builtin.debug:
        msg:
          - "Total rules in filtered report: {{ _filtered_report.results | length }}"
          - "Rule IDs: {{ _filtered_report.results | map(attribute='stig_id') | list }}"
          - "Scored rules only: {{ _filtered_report.results | selectattr('scored', 'equalto', true) | map(attribute='stig_id') | list }}"

    - name: Set filtered scored rules
      ansible.builtin.set_fact:
        _filtered_scored_rules: "{{ _filtered_report.results | selectattr('scored', 'equalto', true) | list }}"

    - name: Verify only specified rules are present in filtered results
      ansible.builtin.assert:
        that:
          - _filtered_scored_rules | length == 3
          - _filtered_scored_rules | selectattr('stig_id', 'equalto', 'V-254238') | list | length == 1
          - _filtered_scored_rules | selectattr('stig_id', 'equalto', 'V-254247') | list | length == 1
          - _filtered_scored_rules | selectattr('stig_id', 'equalto', 'V-254451') | list | length == 1
        fail_msg: "Filtering failed: Expected exactly 3 scored rules (V-254238, V-254247, V-254451), got {{ _filtered_scored_rules | map(attribute='stig_id') | list }}"
        success_msg: "Only specified rules present: {{ _filtered_scored_rules | map(attribute='stig_id') | list }}"

    - name: Verify excluded rules are NOT present in filtered results
      ansible.builtin.assert:
        that:
          - _filtered_scored_rules | selectattr('stig_id', 'equalto', 'V-254239') | list | length == 0
          - _filtered_scored_rules | selectattr('stig_id', 'equalto', 'V-254248') | list | length == 0
          - _filtered_scored_rules | selectattr('stig_id', 'equalto', 'V-254452') | list | length == 0
        fail_msg: "Filtering failed: Found rules that should have been excluded"
        success_msg: "Excluded rules correctly filtered out"

    - name: Verify filtering works across all categories
      ansible.builtin.assert:
        that:
          - _filtered_scored_rules | selectattr('rule_section', 'equalto', 'Account Policies') | list | length == 1
          - _filtered_scored_rules | selectattr('rule_section', 'equalto', 'Audit Policies') | list | length == 1
          - _filtered_scored_rules | selectattr('rule_section', 'equalto', 'User Rights Assignment') | list | length == 1
        fail_msg: "Cross-category filtering failed"
        success_msg: "Filtering works correctly across Account Policies, Audit Policies, and User Rights categories"

    - name: Display filtering test summary
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "windows_manage_stig_only_rules Test Results"
          - "=========================================="
          - "Requested rules: V-254238, V-254247, V-254451"
          - "Scored rules in report: {{ _filtered_scored_rules | map(attribute='stig_id') | list }}"
          - "Non-scored rules (always included): {{ _filtered_report.results | selectattr('scored', 'equalto', false) | map(attribute='stig_id') | list }}"
          - "Total scored rules: {{ _filtered_scored_rules | length }}"
          - "Total all rules: {{ _filtered_report.results | length }}"
          - "Test Status: PASSED"
          - "=========================================="

  rescue:
    - name: Fail the filtering test
      ansible.builtin.fail:
        msg: "windows_manage_stig_only_rules filtering test failed"
