---
# =============================================================================
# STIG Rule Filtering Test
# Tests windows_manage_stig_only_rules filtering functionality
# Focused on account_policies category for performance
# =============================================================================
- name: Test windows_manage_stig_only_rules filtering functionality
  block:
    - name: Create filtered test output directory
      ansible.windows.win_file:
        path: "{{ test_stig_filtered_output_dir }}"
        state: directory

    - name: Set test rules based on OS version (All from account_policies)
      ansible.builtin.set_fact:
        _test_rules: >-
          {{
            ['V-205660', 'V-205659'] if _version_report.detected_version == '2019' else
            ['V-254238', 'V-254239'] if _version_report.detected_version == '2022' else
            ['V-277985', 'V-277986']
          }}
        _test_excluded_rules: >-
          {{
            ['V-205656'] if _version_report.detected_version == '2019' else
            ['V-254241'] if _version_report.detected_version == '2022' else
            ['V-278038']
          }}

    - name: Apply STIG with only_rules filter (Focused on Account Policies)
      ansible.builtin.include_role:
        name: infra.windows_ops.windows_manage_stig
      vars:
        windows_manage_stig_only_rules: "{{ _test_rules }}"
        windows_manage_stig_categories: ['account_policies']
        windows_manage_stig_report_path: "{{ test_stig_filtered_output_dir }}\\filtered_report.json"
        windows_manage_stig_generate_report: true

    - name: Read filtered compliance report
      ansible.builtin.slurp:
        src: "{{ test_stig_filtered_output_dir }}\\filtered_report.json"
      register: _filtered_report_content

    - name: Parse filtered compliance report
      ansible.builtin.set_fact:
        _filtered_report: "{{ _filtered_report_content.content | b64decode | from_json }}"

    - name: Set filtered scored rules
      ansible.builtin.set_fact:
        _filtered_scored_rules: "{{ _filtered_report.results | selectattr('scored', 'equalto', true) | list }}"

    - name: Verify only specified rules are present in filtered results
      ansible.builtin.assert:
        that:
          - _filtered_scored_rules | length == 2
          - _filtered_scored_rules | selectattr('stig_id', 'equalto', _test_rules[0]) | list | length == 1
          - _filtered_scored_rules | selectattr('stig_id', 'equalto', _test_rules[1]) | list | length == 1
        fail_msg: "Filtering failed: Expected exactly 2 rules ({{ _test_rules }}), got {{ _filtered_scored_rules | map(attribute='stig_id') | list }}"

    - name: Verify excluded rules are NOT present in filtered results
      ansible.builtin.assert:
        that:
          - _filtered_scored_rules | selectattr('stig_id', 'equalto', _test_excluded_rules[0]) | list | length == 0
        fail_msg: "Filtering failed: Found rule {{ _test_excluded_rules[0] }} which should have been excluded."

    - name: Test windows_manage_stig_skip_rules exclusion functionality
      ansible.builtin.include_role:
        name: infra.windows_ops.windows_manage_stig
      vars:
        windows_manage_stig_skip_rules: "{{ [_test_rules[0]] }}" # Skip one of the rules
        windows_manage_stig_categories: ['account_policies']
        windows_manage_stig_report_path: "{{ test_stig_filtered_output_dir }}\\skip_report.json"
        windows_manage_stig_generate_report: true

    - name: Read skip compliance report
      ansible.builtin.slurp:
        src: "{{ test_stig_filtered_output_dir }}\\skip_report.json"
      register: _skip_report_content

    - name: Parse skip compliance report
      ansible.builtin.set_fact:
        _skip_report: "{{ _skip_report_content.content | b64decode | from_json }}"

    - name: Record filtering test results to history
      ansible.builtin.set_fact:
        stig_test_history: "{{ stig_test_history + 
          [_filtered_report | combine({'stage_name': 'Filtered Rules (Only)', 'notes': 'Ran with only_rules list'})] +
          [_skip_report | combine({'stage_name': 'Filtered Rules (Skip)', 'notes': 'Ran with skip_rules list'})]
        }}"

    - name: Verify skipped rule is marked as skipped
      ansible.builtin.assert:
        that:
          - _skip_report.results | selectattr('stig_id', 'equalto', _test_rules[0]) | selectattr('skip_reason', 'defined') | list | length == 1
        fail_msg: "Skip filtering failed: Rule {{ _test_rules[0] }} was not correctly skipped."

  rescue:
    - name: Fail the filtering test
      ansible.builtin.fail:
        msg: "windows_manage_stig_only_rules filtering test failed"
