---
# =============================================================================
# Full STIG Execution Test
# Tests complete STIG role execution with OS version detection and validation
# Supports Windows Server 2019 (V3R7), 2022 (V2R7), and 2025 (V1R1)
# =============================================================================
- name: Test STIG full execution with all rules
  block:
    - name: Create test output directory
      ansible.windows.win_file:
        path: "{{ test_stig_output_dir }}"
        state: directory

    - name: Gather facts before running role
      ansible.builtin.setup:

    - name: Apply STIG hardening (First Run)
      ansible.builtin.include_role:
        name: infra.windows_ops.windows_manage_stig
      vars:
        windows_manage_stig_report_path: "{{ test_stig_output_dir }}\\{{ test_stig_check_report_filename }}"
      register: _stig_first_run

    - name: Verify STIG check report was created
      ansible.windows.win_stat:
        path: "{{ test_stig_output_dir }}\\{{ test_stig_check_report_filename }}"
      register: _stig_check_report

    - name: Apply STIG hardening (Idempotency Run)
      ansible.builtin.include_role:
        name: infra.windows_ops.windows_manage_stig
      vars:
        windows_manage_stig_report_path: "{{ test_stig_output_dir }}\\idempotency_report.json"
      register: _stig_second_run

    - name: Verify Idempotency
      ansible.builtin.assert:
        that:
          - not _stig_second_run.changed
        fail_msg: "Idempotency check failed: Role made changes on the second run."
        success_msg: "Idempotency check passed."

    - name: Assert STIG check report exists
      ansible.builtin.assert:
        that:
          - _stig_check_report.stat.exists
          - _stig_check_report.stat.size > 0

    - name: Read STIG compliance report
      ansible.builtin.slurp:
        src: "{{ test_stig_output_dir }}\\{{ test_stig_check_report_filename }}"
      register: _stig_report_content

    - name: Parse STIG compliance report
      ansible.builtin.set_fact:
        _stig_report: "{{ _stig_report_content.content | b64decode | from_json }}"

    - name: Verify STIG benchmark version matches detected OS
      ansible.builtin.assert:
        that:
          - _stig_report.version is defined
          - |
            (_stig_report.detected_version == '2019' and _stig_report.version == 'V3R7') or
            (_stig_report.detected_version == '2022' and _stig_report.version == 'V2R7') or
            (_stig_report.detected_version == '2025' and _stig_report.version == 'V1R0-1')
        fail_msg: "STIG benchmark version mismatch: OS {{ _stig_report.detected_version }} should have version {{ {'2019': 'V3R7', '2022': 'V2R7', '2025': 'V1R0-1'}[_stig_report.detected_version] }}, got {{ _stig_report.version | default('UNDEFINED') }}"
        success_msg: "STIG benchmark version {{ _stig_report.version }} correctly matched for OS {{ _stig_report.detected_version }}"

    - name: Verify common STIG rules (2019)
      ansible.builtin.assert:
        that:
          - _stig_report.results | selectattr('stig_id', 'equalto', 'V-205855') | list | length > 0  # Orphaned SIDs
          - _stig_report.results | selectattr('stig_id', 'equalto', 'V-205856') | list | length > 0  # UEFI
          - _stig_report.results | selectattr('stig_id', 'equalto', 'V-205857') | list | length > 0  # Secure Boot
          - _stig_report.results | selectattr('stig_id', 'equalto', 'V-205843') | list | length > 0  # Audit Backup
          - _stig_report.results | selectattr('stig_id', 'equalto', 'V-205686') | list | length > 0  # Lock Screen
        fail_msg: "Common STIG rules (2019) not found in report"
        success_msg: "Common STIG rules (2019) confirmed"
      when: _stig_report.detected_version == '2019'

    - name: Verify common STIG rules (2022)
      ansible.builtin.assert:
        that:
          - _stig_report.results | selectattr('stig_id', 'equalto', 'V-254282') | list | length > 0  # Orphaned SIDs
          - _stig_report.results | selectattr('stig_id', 'equalto', 'V-254283') | list | length > 0  # UEFI
          - _stig_report.results | selectattr('stig_id', 'equalto', 'V-254284') | list | length > 0  # Secure Boot
          - _stig_report.results | selectattr('stig_id', 'equalto', 'V-254294') | list | length > 0  # Audit Backup
          - _stig_report.results | selectattr('stig_id', 'equalto', 'V-254333') | list | length > 0  # Lock Screen
        fail_msg: "Common STIG rules (2022) not found in report"
        success_msg: "Common STIG rules (2022) confirmed"
      when: _stig_report.detected_version == '2022'

    - name: Verify common STIG rules (2025)
      ansible.builtin.assert:
        that:
          - _stig_report.results | selectattr('stig_id', 'equalto', 'V-278030') | list | length > 0  # Orphaned SIDs
          - _stig_report.results | selectattr('stig_id', 'equalto', 'V-278031') | list | length > 0  # UEFI
          - _stig_report.results | selectattr('stig_id', 'equalto', 'V-278032') | list | length > 0  # Secure Boot
          - _stig_report.results | selectattr('stig_id', 'equalto', 'V-278041') | list | length > 0  # Audit Backup
          - _stig_report.results | selectattr('stig_id', 'equalto', 'V-278080') | list | length > 0  # Lock Screen
        fail_msg: "Common STIG rules (2025) not found in report"
        success_msg: "Common STIG rules (2025) confirmed"
      when: _stig_report.detected_version == '2025'

    - name: Verify version-specific STIG rules (2022)
      ansible.builtin.assert:
        that:
          - _stig_report.results | selectattr('stig_id', 'equalto', 'V-254491') | list | length > 0  # Access Credential Manager (2022)
          - _stig_report.results | selectattr('stig_id', 'equalto', 'V-271426') | list | length > 0  # DC cert auth (2022)
        fail_msg: "Version-specific STIG rules (2022) not found in compliance report"
        success_msg: "Version-specific STIG rules (2022) confirmed in compliance report"
      when: _stig_report.detected_version == '2022'

    - name: Verify version-specific STIG rules (2025)
      ansible.builtin.assert:
        that:
          - _stig_report.results | selectattr('stig_id', 'equalto', 'V-278241') | list | length > 0  # Access Credential Manager (2025)
          - _stig_report.results | selectattr('stig_id', 'equalto', 'V-278172') | list | length > 0  # Strong Cert Binding (2025)
        fail_msg: "Version-specific STIG rules (2025) not found in compliance report"
        success_msg: "Version-specific STIG rules (2025) confirmed in compliance report"
      when: _stig_report.detected_version == '2025'

    - name: Verify deprecated rule V-254411 is NOT present
      ansible.builtin.assert:
        that:
          - _stig_report.results | selectattr('stig_id', 'equalto', 'V-254411') | list | length == 0
        fail_msg: "Deprecated rule V-254411 still present in results"
        success_msg: "Deprecated rule V-254411 correctly removed"

    - name: Verify Manual Controls are reported
      ansible.builtin.assert:
        that:
          - _stig_report.results | selectattr('rule_section', 'equalto', 'Manual Controls') | list | length > 0
        fail_msg: "No Manual Controls found in the report"
        success_msg: "Manual Controls correctly reported"

    - name: Record full execution results to history
      ansible.builtin.set_fact:
        stig_test_history: "{{ stig_test_history + [_stig_report | combine({'stage_name': 'Full STIG Hardening', 'notes': 'Complete role execution'})] }}"

    - name: Display test completion message
      ansible.builtin.debug:
        msg: "STIG full execution test completed successfully"

  rescue:
    - name: Fail the test
      ansible.builtin.fail:
        msg: "STIG full execution test failed"
